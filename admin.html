<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lamaa ‚Äî Admin</title>
  <style>
    :root{
      --bg1:#e6f7ff; --bg2:#f0fffb; --ink:#0f1a2b;
      --card:#ffffff; --line:#e6eef8;
      --red:#ef4444; --green:#00d2a0; --blue:#0ea5e9;
      --muted:#5f7aa3;
    }
    *{box-sizing:border-box}
    body{
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 80% -10%, var(--bg1), transparent 60%), linear-gradient(180deg, var(--bg1), var(--bg2));
      color:var(--ink); margin:0
    }
    header{
      display:flex; align-items:center; gap:12px; padding:10px 14px;
      background:linear-gradient(135deg, rgba(14,165,233,.12), rgba(0,210,160,.10)), #ffffffaa;
      border-bottom:1px solid var(--line);
      backdrop-filter:saturate(1.2) blur(2px);
      position:sticky; top:0; z-index:5;
    }
    header img{width:44px;height:44px;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,.06)}
    header h3{margin:0;font-size:1.15rem}
    header small{color:var(--muted)}
    .wrap{max-width:980px;margin:12px auto 96px;padding:0 12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:10px 0;box-shadow:0 8px 22px rgba(0,0,0,.05);position:relative}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .pill{padding:4px 10px;border-radius:999px;background:#eaf4ff;color:#0b4a7a;font-size:12px;border:1px solid var(--line)}
    button{border:none;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:800}
    button.red{background:var(--red);color:#fff}
    button.green{background:var(--green);color:#003326}
    button.blue{background:var(--blue);color:#fff}
    button.ghost{background:#eef6ff;color:#0f3c6e}
    button:disabled{opacity:.85;filter:saturate(.85);cursor:not-allowed}
    small{opacity:.85;color:var(--muted)}
    .empty{opacity:.8;text-align:center;padding:16px}
    .tools{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .value{font-weight:700}
    .section-title{margin:10px 0 0;font-size:.95rem;color:#123}
    .queue-col{position:absolute;top:10px;right:10px;display:flex;flex-direction:column;align-items:center;gap:6px}
    .queue-badge{min-width:38px;height:38px;display:grid;place-items:center;background:#ffb020;color:#111;font-weight:900;border-radius:10px;border:1px solid #e09a1c;font-size:18px;box-shadow:0 4px 14px rgba(0,0,0,.12)}
    .queue-time{font-size:12px;color:var(--muted);font-weight:800}
  </style>
</head>
<body>
<header>
  <img src="https://i.ibb.co/k2wtWBrW/unnamed.jpg" alt="Lamaa logo">
  <div>
    <h3>Lamaa ‚Äî Admin Panel</h3>
    <small id="permNote">üîî Enable notifications</small>
  </div>
</header>

<div class="wrap" id="list"></div>

<audio id="ding" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
  // Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyC_kRUAmKIFQwWK0Xrr8PeebnQbWGauu34",
    authDomain: "wash-a7ef9.firebaseapp.com",
    projectId: "wash-a7ef9",
    storageBucket: "wash-a7ef9.firebasestorage.app",
    messagingSenderId: "244309029995",
    appId: "1:244309029995:web:b5cb0534edce26aac3ed2e"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Desktop notifications (optional)
  if ('Notification' in window) {
    Notification.requestPermission().then(p=>{
      document.getElementById('permNote').textContent =
        (p==='granted' ? 'Notifications enabled ‚úÖ' : 'üîî Enable notifications from your browser');
    });
  }

  const list = document.getElementById('list');
  const ding  = document.getElementById('ding');

  // State
  const ACTIVE_STATUSES = ['pending','accepted','confirmed']; // queue
  const live = new Map(); // id -> data

  function renderFromLive(){
    const arr = Array.from(live.values())
      .sort((a,b)=> (a.createdAtMs||0) - (b.createdAtMs||0)); // oldest first
    render(arr);
  }

  // Quick read test
  db.collection('bookings').limit(1).get()
    .then(()=>console.log('[admin] read test OK'))
    .catch(err=>{
      console.error('[admin] read test failed:', err);
      list.innerHTML = `
        <div class="card" style="border-color:#ffb4b4">
          Failed to read bookings from Firestore (rules may block reads).<br>
          <small>Open Console for details.</small>
        </div>`;
    });

  // Live listener (order; filter client-side to avoid composite index)
  let unsub = db.collection('bookings')
    .orderBy('createdAtMs')
    .onSnapshot(
      snap=>{
        const docs = [];
        snap.forEach(d=> docs.push({ id:d.id, ...d.data() }));
        const actives = docs.filter(x => ACTIVE_STATUSES.includes(x.status));
        live.clear();
        actives.forEach(x => live.set(x.id, x));
        renderFromLive();
      },
      err=>{
        console.error('[admin] onSnapshot error:', err);
        list.innerHTML = `
          <div class="card" style="border-color:#ffb4b4">
            Realtime updates failed: ${err.message || err}
          </div>`;
      }
    );

  // Helpers
  function money(n){ return (+(n||0)).toFixed(2) + ' OMR'; }
  function washLabel(s){
    return s==='both' ? 'Exterior + Interior' :
           s==='external' ? 'Exterior only' : '‚Äî';
  }
  function statusLabel(s){
    return s==='pending'   ? 'Pending' :
           s==='accepted'  ? 'Accepted' :
           s==='confirmed' ? 'Paid/Confirmed' :
           s==='completed' ? 'Completed' :
           s==='rejected'  ? 'Rejected' : s;
  }
  function carTypeLabel(v){
    if (v==='small' || v==='ÿµÿßŸÑŸàŸÜ') return 'small';
    if (v==='4x4'  || v==='ŸÅŸàÿ±ŸàŸäŸÑ') return '4x4';
    return v || '‚Äî';
  }
  function fmt12(input){
    if (!input) return '‚Äî';
    const t = (typeof input === 'number') ? input :
              (typeof input === 'string' ? Date.parse(input) : 0);
    if (!t) return '‚Äî';
    const d = new Date(t);
    return d.toLocaleString('en-US', {
      year:'numeric', month:'short', day:'2-digit',
      hour:'2-digit', minute:'2-digit', hour12:true
    });
  }
  function openDirections(lat, lng){
    const la = parseFloat(lat), ln = parseFloat(lng);
    if (!Number.isFinite(la) || !Number.isFinite(ln)){
      console.warn('Location is missing for this booking.');
      return;
    }
    const url = `https://www.google.com/maps/dir/?api=1&destination=${la},${ln}`;
    window.open(url, '_blank');
  }

  function render(items){
    list.innerHTML = '';
    if (!items.length){
      list.innerHTML = '<div class="empty">No (pending/accepted/paid) bookings.</div>';
      return;
    }
    items.forEach((x, idx)=>{
      const el = document.createElement('div');
      el.className = 'card';
      const acceptedOrPaid = (x.status === 'accepted' || x.status === 'confirmed');
      const plate = `${(x.carCode||'').toString().toUpperCase()} ${x.carNumber||''}`.trim();
      const position = idx + 1;

      el.innerHTML = `
        <div class="queue-col">
          <div class="queue-badge">${position}</div>
          <div class="queue-time">${fmt12(x.createdAtMs || x.createdAt)}</div>
        </div>

        <div class="row" style="justify-content:flex-start;">
          <div class="pill">Status: ${statusLabel(x.status)}</div>
        </div>

        <div class="section-title">Customer</div>
        <div class="row">
          <div><b>Phone:</b> <span class="value">${x.phone || '‚Äî'}</span></div>
          <div><b>Car Type:</b> <span class="value">${carTypeLabel(x.carType)}</span></div>
          <div><b>Wash:</b> <span class="value">${washLabel(x.package)}</span></div>
          <div><b>Price:</b> <span class="value">${money(x.price)}</span></div>
        </div>

        <div class="section-title">Vehicle</div>
        <div class="row">
          <div><b>Plate:</b> <span class="value">${plate || '‚Äî'}</span></div>
        </div>

        <div class="section-title">Location</div>
        <div class="row" style="justify-content:flex-end">
          <button class="ghost" onclick="openDirections('${x.lat}','${x.lng}')">üìç location</button>
        </div>

        <div class="tools">
          <button class="${acceptedOrPaid?'green':'blue'}"
                  id="assign-${x.id}"
                  ${acceptedOrPaid?'disabled':''}
                  onclick="markAccepted('${x.id}', this)">${acceptedOrPaid?'Accepted/Paid':'Accept'}</button>

          <button class="green" id="done-${x.id}"   onclick="markCompleted('${x.id}', this)">Complete ‚úî</button>
          <button class="red"   id="reject-${x.id}" onclick="markRejected('${x.id}', this)">Reject ‚úñ</button>
        </div>
      `;
      list.appendChild(el);
    });
  }

  // Action buttons
  async function markAccepted(id, btn){
    if (btn && btn.classList.contains('green')) return;
    await db.collection('bookings').doc(id).update({
      status:'accepted', acceptedAt:new Date().toISOString()
    });
    if (btn){
      btn.classList.remove('blue');
      btn.classList.add('green');
      btn.textContent = 'Accepted';
      btn.disabled = true;
    }
  }

  async function markRejected(id, btn){
    await db.collection('bookings').doc(id).update({
      status:'rejected', rejectedAt:new Date().toISOString()
    });
  }

  async function markCompleted(id, btn){
    await db.collection('bookings').doc(id).update({
      status:'completed', completedAt:new Date().toISOString()
    });
  }
</script>

<!-- ================== ÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿπŸÖŸÑ ‚Äî ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ£ÿØŸÖŸÜ ================== -->
<style>
  .wh-fab{position:fixed;z-index:9999;bottom:18px;left:18px;background:#1f6fff;color:#fff;
    border:none;border-radius:999px;display:flex;align-items:center;gap:10px;padding:12px 16px;
    box-shadow:0 10px 30px rgba(31,111,255,.35);cursor:pointer;font-family:'Tajawal',sans-serif}
  .wh-fab svg{width:20px;height:20px}
  .wh-modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.45);backdrop-filter:blur(2px);display:none;z-index:9998}
  .wh-modal{position:fixed;inset:0;display:none;place-items:center;z-index:9999}
  .wh-card{width:min(980px,96vw);max-height:90vh;overflow:auto;background:#fff;border-radius:16px;
    box-shadow:0 20px 60px rgba(2,6,23,.25);padding:18px 18px 12px;direction:rtl}
  .wh-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .wh-hdr h3{font:700 20px/1.2 'Tajawal',system-ui;margin:0}
  .wh-close{background:transparent;border:none;font-size:22px;cursor:pointer}
  .wh-day{min-width:110px}
  .wh-row{display:grid;grid-template-columns:140px 1fr 1fr 120px;gap:10px;align-items:center}
  .wh-period{display:grid;grid-template-columns:90px 120px 30px 120px;align-items:center;gap:8px}
  .wh-period label{color:#64748b;font-weight:600}
  .wh-note{font:400 13px/1.6 'Tajawal',system-ui;color:#475569;background:#f8fafc;border:1px dashed #e2e8f0;
    padding:10px;border-radius:10px;margin:12px 0}
  .wh-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  .wh-btn{border:none;border-radius:10px;padding:10px 14px;font:700 14px 'Tajawal',system-ui;cursor:pointer}
  .wh-btn.primary{background:#1f6fff;color:#fff}
  .wh-btn.secondary{background:#edf2ff;color:#1e3a8a}
  .wh-switch{display:inline-flex;align-items:center;gap:6px}
  .wh-switch input{accent-color:#1f6fff}
  .wh-inline{display:flex;align-items:center;gap:6px}
  .wh-muted{color:#6b7280}
  .wh-badge{display:inline-block;background:#eef2ff;color:#1e3a8a;border-radius:999px;padding:3px 10px;font:700 12px 'Tajawal'}
  .wh-mini{font:600 12px 'Tajawal';color:#64748b}
  .wh-grid{display:grid;grid-template-columns:repeat(1, minmax(0,1fr));gap:10px}
  @media(min-width:860px){.wh-grid{grid-template-columns:repeat(1,minmax(0,1fr));}}
</style>

<button type="button" class="wh-fab" id="whOpenFab" title="ÿ£ŸàŸÇÿßÿ™ ÿßŸÑÿπŸÖŸÑ">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="9"/></svg>
  <span>ÿ£ŸàŸÇÿßÿ™ ÿßŸÑÿπŸÖŸÑ</span>
</button>

<div class="wh-modal-backdrop" id="whBackdrop"></div>
<div class="wh-modal" id="whModal" role="dialog" aria-modal="true" aria-labelledby="whTitle">
  <div class="wh-card">
    <div class="wh-hdr">
      <h3 id="whTitle">ÿ•ÿπÿØÿßÿØ ÿ£ŸàŸÇÿßÿ™ ÿßŸÑÿπŸÖŸÑ <span class="wh-badge">ŸÅÿ™ÿ±ÿ™ÿßŸÜ ŸäŸàŸÖŸäŸãÿß (ÿßŸÑÿ´ÿßŸÜŸäÿ© ÿßÿÆÿ™Ÿäÿßÿ±Ÿäÿ©)</span></h3>
      <button class="wh-close" id="whCloseBtn" aria-label="ÿ•ÿ∫ŸÑÿßŸÇ">√ó</button>
    </div>
    <div class="wh-note">
      ÿ≠ÿØÿØ ÿ£ŸàŸÇÿßÿ™ ÿßŸÑÿπŸÖŸÑ ŸÑŸÉŸÑ ŸäŸàŸÖ. ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖŸÉÿßŸÜ ŸÖÿ∫ŸÑŸÇŸãÿß ŸÅŸä ŸäŸàŸÖ ŸÖÿπŸäŸÜÿå ŸÅÿπŸëŸÑ ÿÆŸäÿßÿ± <b>ŸÖÿ∫ŸÑŸÇ</b>. 
      ŸÑŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ© ÿßÿÆÿ™ÿ± <span class="wh-mini">ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©</span> ÿ´ŸÖ ÿ£ÿØÿÆŸÑ ÿßŸÑÿ£ŸàŸÇÿßÿ™.
    </div>
    <div id="whDaysContainer" class="wh-grid"></div>
    <div class="wh-actions">
      <button class="wh-btn secondary" id="whReset">ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä</button>
      <button class="wh-btn primary" id="whSave">ÿ≠ŸÅÿ∏</button>
    </div>
  </div>
</div>

<script>
(function(){
  const DAYS_AR = ["ÿßŸÑÿ≥ÿ®ÿ™","ÿßŸÑÿ£ÿ≠ÿØ","ÿßŸÑÿ•ÿ´ŸÜŸäŸÜ","ÿßŸÑÿ´ŸÑÿßÿ´ÿßÿ°","ÿßŸÑÿ£ÿ±ÿ®ÿπÿßÿ°","ÿßŸÑÿÆŸÖŸäÿ≥","ÿßŸÑÿ¨ŸÖÿπÿ©"];
  const STORAGE_KEY = "businessHoursV1";

  const defaultHours = [
    {closed:false, p1:{from:"08:00", to:"13:00"}, p2:{enabled:true, from:"16:00", to:"20:00"}},
    {closed:false, p1:{from:"08:00", to:"13:00"}, p2:{enabled:true, from:"16:00", to:"20:00"}},
    {closed:false, p1:{from:"08:00", to:"13:00"}, p2:{enabled:true, from:"16:00", to:"20:00"}},
    {closed:false, p1:{from:"08:00", to:"13:00"}, p2:{enabled:true, from:"16:00", to:"20:00"}},
    {closed:false, p1:{from:"08:00", to:"13:00"}, p2:{enabled:true, from:"16:00", to:"20:00"}},
    {closed:false, p1:{from:"08:00", to:"12:00"}, p2:{enabled:false, from:"", to:""}},
    {closed:true,  p1:{from:"", to:""},            p2:{enabled:false, from:"", to:""}}
  ];

  function loadHours(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw){ return JSON.parse(JSON.stringify(defaultHours)); }
      const parsed = JSON.parse(raw);
      if(!Array.isArray(parsed) || parsed.length!==7) return JSON.parse(JSON.stringify(defaultHours));
      return parsed;
    }catch(e){
      return JSON.parse(JSON.stringify(defaultHours));
    }
  }

  function saveHours(hours){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(hours));
      return true;
    }catch(e){
      console.warn("ÿ™ÿπÿ∞ÿ± ÿßŸÑÿ≠ŸÅÿ∏ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÖÿ™ÿµŸÅÿ≠. ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ.");
      return false;
    }
  }

  function rowTemplate(dayIdx){
    return `
      <div class="wh-row" data-day="${dayIdx}">
        <div class="wh-day">
          <div class="wh-inline"><strong>${DAYS_AR[dayIdx]}</strong></div>
          <label class="wh-switch wh-muted">
            <input type="checkbox" class="wh-closed"> ŸÖÿ∫ŸÑŸÇ
          </label>
        </div>
        <div class="wh-period">
          <label>ÿßŸÑŸÅÿ™ÿ±ÿ© Ÿ°</label>
          <input type="time" class="wh-p1-from" required>
          <span>‚Äì</span>
          <input type="time" class="wh-p1-to" required>
        </div>
        <div class="wh-period">
          <label class="wh-inline">
            <input type="checkbox" class="wh-p2-enabled"> ÿ™ŸÅÿπŸäŸÑ Ÿ¢
          </label>
          <input type="time" class="wh-p2-from">
          <span>‚Äì</span>
          <input type="time" class="wh-p2-to">
        </div>
        <div style="text-align:end"><span class="wh-mini wh-muted">ÿßŸÑÿ™ŸàŸÇŸäÿ™ 24 ÿ≥ÿßÿπÿ©</span></div>
      </div>
    `;
  }

  function render(container, hours){
    container.innerHTML = Array.from({length:7}, (_,i)=>rowTemplate(i)).join("");
    Array.from(container.querySelectorAll(".wh-row")).forEach((row, idx)=>{
      const h = hours[idx];
      row.querySelector(".wh-closed").checked = !!h.closed;
      row.querySelector(".wh-p1-from").value = h.p1.from || "";
      row.querySelector(".wh-p1-to").value   = h.p1.to   || "";
      row.querySelector(".wh-p2-enabled").checked = !!h.p2.enabled;
      row.querySelector(".wh-p2-from").value = h.p2.from || "";
      row.querySelector(".wh-p2-to").value   = h.p2.to   || "";
      applyRowState(row);
      row.querySelector(".wh-closed").addEventListener("change", ()=>applyRowState(row));
      row.querySelector(".wh-p2-enabled").addEventListener("change", ()=>applyRowState(row));
    });
  }

  function applyRowState(row){
    const isClosed = row.querySelector(".wh-closed").checked;
    const p2Enabled = row.querySelector(".wh-p2-enabled").checked;
    [".wh-p1-from",".wh-p1-to"].forEach(sel=>{
      const el=row.querySelector(sel);
      el.disabled = isClosed;
      el.required = !isClosed;
      el.style.opacity = isClosed? .5:1;
    });
    [".wh-p2-from",".wh-p2-to"].forEach(sel=>{
      const el=row.querySelector(sel);
      el.disabled = isClosed || !p2Enabled;
      el.required = false;
      el.style.opacity = (isClosed||!p2Enabled)? .5:1;
    });
  }

  function collect(container){
    const hours = new Array(7).fill(0).map(()=>({}));
    let ok = true;
    Array.from(container.querySelectorAll(".wh-row")).forEach(row=>{
      const idx = Number(row.getAttribute("data-day"));
      const closed = row.querySelector(".wh-closed").checked;
      const p1from = row.querySelector(".wh-p1-from").value;
      const p1to   = row.querySelector(".wh-p1-to").value;
      const p2en   = row.querySelector(".wh-p2-enabled").checked;
      const p2from = row.querySelector(".wh-p2-from").value;
      const p2to   = row.querySelector(".wh-p2-to").value;

      if(!closed){
        if(!(p1from && p1to)){
          alert("Ÿäÿ¨ÿ® ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ£ŸàŸÑŸâ ŸÑŸÑŸäŸàŸÖ: " + (DAYS_AR[idx]));
          ok=false; return;
        }
        if(p1to <= p1from){
          alert("ŸÜŸáÿßŸäÿ© ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ£ŸàŸÑŸâ Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿ®ÿπÿØ ÿ®ÿØÿßŸäÿ™Ÿáÿß (" + DAYS_AR[idx] + ")");
          ok=false; return;
        }
        if(p2en){
          if(!(p2from && p2to)){
            alert("ÿ£ŸÉŸÖŸÑ ÿ≤ŸÖŸÜ ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ© ŸÑŸÑŸäŸàŸÖ: " + (DAYS_AR[idx]));
            ok=false; return;
          }
          if(p2to <= p2from){
            alert("ŸÜŸáÿßŸäÿ© ÿßŸÑŸÅÿ™ÿ±ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ© Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿ®ÿπÿØ ÿ®ÿØÿßŸäÿ™Ÿáÿß (" + DAYS_AR[idx] + ")");
            ok=false; return;
          }
        }
      }

      hours[idx] = {
        closed,
        p1:{from:p1from||"", to:p1to||""},
        p2:{enabled:p2en, from:p2from||"", to:p2to||""}
      };
    });
    return ok ? hours : null;
  }

  const whBackdrop = document.getElementById("whBackdrop");
  const whModal = document.getElementById("whModal");
  const whClose = document.getElementById("whCloseBtn");
  const whOpenFab = document.getElementById("whOpenFab");
  const whReset = document.getElementById("whReset");
  const whSave = document.getElementById("whSave");
  const whDays = document.getElementById("whDaysContainer");

  function openModal(){
    render(whDays, loadHours());
    whBackdrop.style.display = "block";
    whModal.style.display = "grid";
  }
  function closeModal(){
    whBackdrop.style.display = "none";
    whModal.style.display = "none";
  }

  whOpenFab.addEventListener("click", openModal);
  whClose.addEventListener("click", closeModal);
  whBackdrop.addEventListener("click", closeModal);
  whReset.addEventListener("click", ()=>render(whDays, JSON.parse(JSON.stringify(defaultHours))));
  whSave.addEventListener("click", ()=>{
    const data = collect(whDays);
    if(!data) return;
    if(saveHours(data)){
      closeModal();
      console.warn("ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ£ŸàŸÇÿßÿ™ ÿßŸÑÿπŸÖŸÑ ÿ®ŸÜÿ¨ÿßÿ≠.");
      window.dispatchEvent(new CustomEvent("business-hours-updated", {detail:data}));
    }
  });

  // expose helper
  window.__getBusinessHours = ()=>loadHours();
})();
</script>

<!-- === Firestore Hours: robust push on Save + manual sync (ADMIN) === -->
<style>
  .bh-admin-sync{position:fixed;left:12px;bottom:12px;z-index:99998;background:#fff;border:1px solid #e5e7eb;
    border-radius:12px;padding:8px 10px;font:700 12px 'Tajawal',system-ui;color:#0f172a;display:flex;gap:8px;align-items:center;box-shadow:0 8px 32px rgba(2,6,23,.12)}
  .bh-admin-sync button{border:none;border-radius:8px;background:#1f6fff;color:#fff;font:800 12px 'Tajawal';padding:6px 10px;cursor:pointer}
  .bh-muted{color:#64748b;font-weight:600}
</style>
<div class="bh-admin-sync">
  <span class="bh-muted">Firestore</span>
  <button id="bhAdminPull">ÿ≥ÿ≠ÿ® ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©</button>
  <button id="bhAdminPush">ÿØŸÅÿπ ŸÑŸÑÿ≥ÿ≠ÿßÿ®ÿ©</button>
</div>
<script>
(function(){
  const STORAGE_KEY="businessHoursV1";
  function ensureDb(){
    try{
      if(window.db) return window.db;
      if(window.firebase && firebase.firestore && firebase.apps && firebase.apps.length){
        window.db = firebase.firestore(); return window.db;
      }
    }catch(e){}
    return null;
  }
  const db = ensureDb();
  if(!db){ console.warn('[admin] Firebase db ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±'); return; }
  const docRef = db.collection('config').doc('businessHours');
  const SV = firebase.firestore.FieldValue;

  async function pull(){
    try{
      const snap = await docRef.get();
      if(snap.exists && Array.isArray(snap.data().hours) && snap.data().hours.length===7){
        localStorage.setItem(STORAGE_KEY, JSON.stringify(snap.data().hours));
        window.dispatchEvent(new CustomEvent("business-hours-updated", { detail: snap.data().hours }));
        console.warn('ÿ™ŸÖ ÿ≥ÿ≠ÿ® ÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿπŸÖŸÑ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©.');
      }else{
        console.warn('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿµÿßŸÑÿ≠ÿ© ŸÅŸä ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©.');
      }
    }catch(e){ console.warn(e); console.warn('ŸÅÿ¥ŸÑ ÿßŸÑÿ≥ÿ≠ÿ® ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©.'); }
  }

  async function push(hours){
    try{
      if(!(Array.isArray(hours) && hours.length===7)) { console.warn('ÿ®ŸäÿßŸÜÿßÿ™ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ÿ©.'); return; }
      await docRef.set({hours, updatedAt: SV.serverTimestamp()}, {merge:true});
      console.warn('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿπŸÖŸÑ ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©.');
    }catch(e){ console.warn(e); console.warn('ÿ™ÿπÿ∞ÿ± ÿßŸÑÿ≠ŸÅÿ∏ ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©.'); }
  }

  // Manual buttons
  document.getElementById('bhAdminPull').addEventListener('click', pull);
  document.getElementById('bhAdminPush').addEventListener('click', ()=>{
    try{
      const hours = JSON.parse(localStorage.getItem(STORAGE_KEY)||'null');
      push(hours);
    }catch(e){ console.warn('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÑŸäÿ© ŸÑŸÑÿ≠ŸÅÿ∏.'); }
  });

  // Hook the Save button of hours widget if present
  const saveBtn = document.getElementById('whSave');
  if(saveBtn){
    saveBtn.addEventListener('click', ()=>{
      // give the widget a moment to write to localStorage
      setTimeout(()=>{
        try{
          const hours = JSON.parse(localStorage.getItem(STORAGE_KEY)||'null');
          push(hours);
        }catch(e){ /* ignore */ }
      }, 300);
    });
  }

  // Also react to custom event (for compatibility with previous versions)
  window.addEventListener('business-hours-updated', (ev)=>{
    const hours = ev && ev.detail;
    if(hours) push(hours);
  });
})();
</script>


<!-- ===== Firestore sync for Business Hours (ADMIN, compat) ===== -->
<script>
(function(){
  const STORAGE_KEY = "businessHoursV1";
  if(!(window.firebase && firebase.firestore)){ console.warn("[admin-hours] Firebase not found"); return; }
  // ensure db
  window.db = window.db || firebase.firestore();
  const HOURS_DOC = db.collection('config').doc('businessHours');
  const SV = firebase.firestore.FieldValue;

  // Anonymous auth to allow write if rules require auth
  if (firebase.auth) { firebase.auth().signInAnonymously().catch(console.warn); }

  async function pullFromCloud(){
    try{
      const snap = await HOURS_DOC.get();
      const d = snap.exists && snap.data();
      if(d && Array.isArray(d.hours) && d.hours.length===7){
        localStorage.setItem(STORAGE_KEY, JSON.stringify(d.hours));
        window.dispatchEvent(new CustomEvent("business-hours-updated", { detail: d.hours }));
        console.log("[admin-hours] pulled from cloud");
      }else{
        console.log("[admin-hours] cloud doc missing or malformed");
      }
    }catch(e){ console.warn("[admin-hours] pull error:", e); }
  }

  // Push when our widget dispatches 'business-hours-updated'
  window.addEventListener("business-hours-updated", async (ev)=>{
    try{
      const hours = ev && ev.detail;
      if(!(Array.isArray(hours) && hours.length===7)) return;
      await HOURS_DOC.set({ hours, updatedAt: SV.serverTimestamp() }, { merge:true });
      console.log("[admin-hours] pushed to cloud");
    }catch(e){ console.warn("[admin-hours] push error:", e); console.warn("ÿ™ÿπÿ∞ÿ± ÿ≠ŸÅÿ∏ ÿ£ŸàŸÇÿßÿ™ ÿßŸÑÿπŸÖŸÑ ÿπŸÑŸâ ÿßŸÑÿ≥ÿ≠ÿßÿ®ÿ©."); }
  });

  // Fallback: hook Save button if present (id=whSave)
  const saveBtn = document.getElementById("whSave");
  if(saveBtn){
    saveBtn.addEventListener("click", ()=>{
      setTimeout(async ()=>{
        try{
          const hours = JSON.parse(localStorage.getItem(STORAGE_KEY)||"null");
          if(Array.isArray(hours) && hours.length===7){
            await HOURS_DOC.set({ hours, updatedAt: SV.serverTimestamp() }, { merge:true });
            console.log("[admin-hours] push (via Save)");
          }
        }catch(e){ console.warn(e); }
      }, 300);
    });
  }

  // Live updates (if another admin edits)
  try{
    HOURS_DOC.onSnapshot((snap)=>{
      const d = snap.data && snap.data();
      if(snap.exists && d && Array.isArray(d.hours) && d.hours.length===7){
        localStorage.setItem(STORAGE_KEY, JSON.stringify(d.hours));
        console.log("[admin-hours] live update");
      }
    }, (err)=>console.warn("[admin-hours] live sub error:", err));
  }catch(e){ console.warn("[admin-hours] live sub failed:", e); }

  pullFromCloud();
})();
</script>


<style>.bh-admin-sync{display:none!important}</style>
</body>
</html>
