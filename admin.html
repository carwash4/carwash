<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة التحكم — أوقات العمل</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#f7fbff; --card:#ffffff; --fg:#0f172a; --muted:#64748b; --primary:#1f6fff; --border:#e5e7eb; --danger:#ef4444; }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:linear-gradient(180deg,#f3f7ff 0%,#eef4ff 100%);font-family:'Tajawal',system-ui}
    .wrap{max-width:1100px;margin:28px auto;padding:0 14px}
    .title{font:800 24px 'Tajawal';color:var(--fg)}
    .panel{margin-top:16px;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 16px 60px rgba(2,6,23,.06)}
    .row{display:grid;grid-template-columns:110px 1fr 1fr 1fr;gap:10px;align-items:center;padding:10px;border-bottom:1px dashed #e5e7eb}
    .row:last-child{border-bottom:none}
    .day{font:800 14px;color:#0f172a}
    .field{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .field label{font:700 13px;color:#0f172a}
    .field input[type="time"]{padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px;font:700 13px 'Tajawal'}
    .field input[type="checkbox"]{transform:scale(1.1)}
    .actions{display:flex;gap:10px;justify-content:flex-start;margin-top:12px}
    .btn{border:none;border-radius:12px;background:var(--primary);color:#fff;font:800 14px 'Tajawal';padding:10px 14px;cursor:pointer}
    .muted{color:var(--muted);font-weight:600}
    .toast{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:99999;display:none;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:10px 14px;font:800 13px 'Tajawal';color:#0f172a;box-shadow:0 20px 60px rgba(2,6,23,.18)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">لوحة التحكم — <span class="muted">أوقات العمل</span></div>
    <div class="panel">
      <div class="muted">اضبط أوقات العمل لكل يوم. للفترة الثانية فعّل خيار <b>تفعيل ٢</b> ثم أدخل الوقت.</div>
      <div id="hoursGrid"></div>
      <div class="actions">
        <button class="btn" id="whSave">حفظ</button>
        <div class="muted">سيتم حفظ الإعدادات في السحابة (Firestore) وتطبيقها على جميع الأجهزة.</div>
      </div>
    </div>
    <div class="muted" style="margin-top:14px">
      ملاحظة: فعّل Anonymous Auth وأضف نطاق <code>*.github.io</code> في Authorized domains.
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Firebase SDK v8 compat -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <script>
  // TODO: ضع تهيئة مشروعك هنا إذا لم تكن مضافة مسبقًا
  if (!firebase.apps.length) {
    var firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
  }
  window.db = firebase.firestore();
  </script>

  <script>
  const STORAGE_KEY = "businessHoursV1";
  const days = ["السبت","الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة"];
  function defaultHours(){
    return [
      {closed:false,p1:{from:"08:00",to:"13:00"},p2:{enabled:true,from:"16:00",to:"20:00"}},
      {closed:false,p1:{from:"08:00",to:"13:00"},p2:{enabled:true,from:"16:00",to:"20:00"}},
      {closed:false,p1:{from:"08:00",to:"13:00"},p2:{enabled:true,from:"16:00",to:"20:00"}},
      {closed:false,p1:{from:"08:00",to:"13:00"},p2:{enabled:true,from:"16:00",to:"20:00"}},
      {closed:false,p1:{from:"08:00",to:"13:00"},p2:{enabled:true,from:"16:00",to:"20:00"}},
      {closed:false,p1:{from:"08:00",to:"13:00"},p2:{enabled:true,from:"16:00",to:"20:00"}},
      {closed:false,p1:{from:"08:00",to:"13:00"},p2:{enabled:true,from:"16:00",to:"20:00"}},
    ];
  }
  function showToast(msg){
    const el = document.getElementById('toast');
    el.textContent = msg; el.style.display = 'block';
    setTimeout(()=> el.style.display = 'none', 2200);
  }
  </script>

  <script>
  // Anonymous Auth
  (function(){
    let tried = false;
    firebase.auth().onAuthStateChanged(function(user){
      if(user){ window.__bh_signed_in = true; }
      else if(!tried){ tried=true; firebase.auth().signInAnonymously().catch(console.warn); }
    });
  })();
  </script>

  <script>
  // Build UI
  const grid = document.getElementById('hoursGrid');
  function buildRow(idx, data){
    const row = document.createElement('div'); row.className = 'row';
    row.innerHTML = `
      <div class="day">${days[idx]}</div>
      <div class="field">
        <label>مغلق</label>
        <input type="checkbox" data-k="closed" ${data.closed?'checked':''}/>
      </div>
      <div class="field">
        <label>الفترة ١</label>
        <input type="time" data-k="p1.from" value="${data.p1.from}"/>
        <span>—</span>
        <input type="time" data-k="p1.to" value="${data.p1.to}"/>
      </div>
      <div class="field">
        <label>تفعيل ٢</label>
        <input type="checkbox" data-k="p2.enabled" ${data.p2.enabled?'checked':''}/>
        <label>الفترة ٢</label>
        <input type="time" data-k="p2.from" value="${data.p2.from}"/>
        <span>—</span>
        <input type="time" data-k="p2.to" value="${data.p2.to}"/>
      </div>
    `;
    row.querySelector('[data-k="closed"]').addEventListener('change', e=>{
      if(e.target.checked){ row.querySelectorAll('input[type="time"]').forEach(t=>t.disabled=true); }
      else{ row.querySelectorAll('input[type="time"]').forEach(t=>t.disabled=false); }
    });
    if(data.closed){ row.querySelectorAll('input[type="time"]').forEach(t=>t.disabled=true); }
    return row;
  }
  function readGrid(){
    const rows = grid.querySelectorAll('.row');
    const out = [];
    rows.forEach((r)=>{
      const get = sel => r.querySelector(sel);
      const val = (el)=> el && ('value' in el ? el.value : (el.checked||false));
      out.push({
        closed: val(get('[data-k="closed"]')),
        p1: { from: val(get('[data-k="p1.from"]')), to: val(get('[data-k="p1.to"]')) },
        p2: { enabled: val(get('[data-k="p2.enabled"]')), from: val(get('[data-k="p2.from"]')), to: val(get('[data-k="p2.to"]')) }
      });
    });
    return out;
  }
  </script>

  <script>
  // Firestore sync
  (function(){
    const HOURS_DOC = db.collection('config').doc('businessHours');

    function render(hours){
      grid.innerHTML='';
      hours.forEach((h,idx)=> grid.appendChild(buildRow(idx,h)));
    }

    async function seed(){
      try{
        const snap = await HOURS_DOC.get();
        let hours = snap.exists && snap.data() && Array.isArray(snap.data().hours) ? snap.data().hours : defaultHours();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(hours));
        render(hours);
      }catch(e){
        console.warn("[admin] read error:", e);
        render(defaultHours());
      }
    }

    document.getElementById('whSave').addEventListener('click', async ()=>{
      if(!firebase.auth().currentUser){ alert("لا يمكن الحفظ: لم يتم تسجيل الدخول (مجهول)."); return; }
      const hours = readGrid();
      try{
        await HOURS_DOC.set({hours, updatedAt: firebase.firestore.FieldValue.serverTimestamp()}, {merge:true});
        localStorage.setItem(STORAGE_KEY, JSON.stringify(hours));
        window.dispatchEvent(new CustomEvent("business-hours-updated", { detail: hours }));
        showToast("تم الحفظ على السحابة.");
      }catch(e){ console.warn(e); alert("تعذر الحفظ على السحابة."); }
    });

    HOURS_DOC.onSnapshot(snap=>{
      const d = snap.data && snap.data();
      if(snap.exists && d && Array.isArray(d.hours)){ localStorage.setItem(STORAGE_KEY, JSON.stringify(d.hours)); }
    });

    seed();
  })();
  </script>
</body>
</html>