<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lamaa â€” Admin</title>
  <style>
    :root{
      --bg1:#e6f7ff; --bg2:#f0fffb; --ink:#0f1a2b;
      --card:#ffffff; --line:#e6eef8;
      --red:#ef4444; --green:#00d2a0; --blue:#0ea5e9;
      --muted:#5f7aa3;
    }
    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 700px at 80% -10%, var(--bg1), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      color:var(--ink); margin:0;
    }
    header{
      display:flex;align-items:center;gap:12px;
      padding:10px 14px;
      background:linear-gradient(135deg,rgba(14,165,233,.12),rgba(0,210,160,.10)),#ffffffaa;
      border-bottom:1px solid var(--line);
      backdrop-filter:saturate(1.2) blur(2px);
      position:sticky;top:0;z-index:5;
    }
    header img{width:44px;height:44px;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,.06)}
    header h3{margin:0;font-size:1.15rem}
    header small{color:var(--muted)}
    .wrap{max-width:980px;margin:12px auto 96px;padding:0 12px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      margin:10px 0;
      box-shadow:0 8px 22px rgba(0,0,0,.05);
      position:relative;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .empty{opacity:.8;text-align:center;padding:16px}
    .section-title{margin:10px 0 0;font-size:.95rem;color:#123}
    .queue-col{position:absolute;top:10px;right:10px;display:flex;flex-direction:column;align-items:center;gap:6px}
    .queue-badge{
      min-width:38px;height:38px;display:grid;place-items:center;
      background:#111827;color:#fff;border-radius:999px;
      font-weight:800;font-size:17px;
      box-shadow:0 5px 18px rgba(0,0,0,.32);
    }
    .queue-label{font-size:10px;color:#6b7280;font-weight:700}
    .label{font-size:11px;color:#6b7280}
    .field{font-size:13px;margin-top:2px}
    .badge{font-size:10px;padding:2px 6px;border-radius:999px;background:#f3f4ff;color:#4b5563}
    .car-plate{display:inline-flex;align-items:center;gap:6px;margin-top:4px}
    .car-plate span.code{
      padding:2px 6px;border-radius:6px;border:1px solid #d1d5db;
      font-size:11px;font-weight:700;color:#111827
    }
    .car-plate span.num{
      font-size:13px;font-weight:800;color:#111827;
      padding:2px 6px;border-radius:4px;background:#f9fafb
    }

    /* FABs */
    #whOpenFab,#reportFab{
      position:fixed;bottom:18px;z-index:40;
      padding:10px 14px;border-radius:999px;
      display:flex;align-items:center;gap:6px;
      box-shadow:0 8px 22px rgba(15,23,42,.25);
      font-size:13px;border:none;cursor:pointer;font-weight:800;color:#fff;
    }
    #whOpenFab{left:16px;background:#0ea5e9}
    #reportFab{left:170px;background:#111827}
    #whOpenFab span.icon,#reportFab span.icon{font-size:16px}

    /* Backdrops + modals */
    #whBackdrop,#reportBackdrop{
      position:fixed;inset:0;background:rgba(15,23,42,.35);
      display:none;z-index:48;
    }
    #whModal,#reportModal{
      position:fixed;inset:0;display:none;z-index:50;
      place-items:center;pointer-events:none;
    }
    #whModal .wh-box,#reportModal .report-box{
      width:min(800px,96vw);max-height:88vh;overflow:auto;
      background:#ffffff;border-radius:18px;
      padding:16px 14px 14px;
      box-shadow:0 16px 46px rgba(15,23,42,.32);
      pointer-events:auto;
    }
    .wh-title,.report-title{
      display:flex;justify-content:space-between;align-items:center;gap:8px
    }
    .wh-title h4,.report-title h4{margin:0;font-size:15px}
    .wh-close,.report-close{
      border:none;background:transparent;font-size:20px;cursor:pointer
    }

    /* Working hours grid */
    .wh-grid{margin-top:10px;display:flex;flex-direction:column;gap:8px;font-size:12px}
    .wh-row{
      display:grid;
      grid-template-columns:72px 1fr 1.6fr 1.8fr;
      gap:6px;align-items:center;
      padding:6px 8px;border-radius:10px;
      border:1px solid #e5e7eb;background:#f9fafb
    }
    .wh-day-label{font-weight:700;color:#111827;font-size:11px}
    .wh-period{display:flex;align-items:center;gap:4px;font-size:11px;color:#374151}
    .wh-period input[type="time"]{
      padding:4px 6px;border-radius:6px;border:1px solid #e5e7eb;font-size:11px
    }
    .wh-switch{display:flex;align-items:center;gap:4px;font-size:10px}
    .wh-switch input{accent-color:#0ea5e9}
    .wh-mini{font-size:10px}
    .wh-muted{color:#6b7280}
    .wh-actions{margin-top:10px;display:flex;justify-content:flex-end;gap:8px}
    .wh-btn,.report-btn{
      padding:7px 12px;border-radius:10px;border:none;
      font-size:12px;font-weight:700;cursor:pointer
    }
    .wh-btn.secondary{background:#f3f4ff;color:#111827;border:1px solid #e5e7eb}
    .wh-btn.primary{background:#0ea5e9;color:#fff}

    /* Daily report */
    .report-filters{
      margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;font-size:12px
    }
    .report-filters input[type="date"]{
      padding:6px 8px;border-radius:8px;border:1px solid #e5e7eb;font-size:12px
    }
    .report-btn.load{background:#0ea5e9;color:#fff}
    .report-btn.pdf{background:#111827;color:#fff}
    .report-table-wrap{margin-top:10px}
    table.report-table{width:100%;border-collapse:collapse;font-size:11px}
    table.report-table thead{background:#f3f4ff}
    table.report-table th,table.report-table td{
      padding:6px 4px;border-bottom:1px solid #e5e7eb;text-align:center;white-space:nowrap
    }
    #reportEmpty{margin-top:14px}

    /* Tools / status style */
    .tools{
      margin-top:14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .tools button{
      padding:8px 18px;
      border:none;
      border-radius:10px;
      font-size:13px;
      font-weight:700;
      cursor:pointer;
      color:#fff;
    }
    .tools .blue{background:#0ea5e9;}
    .tools .green{background:#10b981;}
    .tools .red{background:#ef4444;}
    .tools button:disabled{
      opacity:.7;
      cursor:default;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      background:#eff6ff;
      color:#1f2937;
      margin-bottom:6px;
    }
    .queue-time{
      font-size:9px;
      color:#6b7280;
    }
.ghost{
  padding:8px 16px;
  border-radius:20px;
  border:1px solid #e5e7eb;
  background:#f9fafb;
  font-size:16px; /* ÙƒØ¨Ø±Ù†Ø§ Ø§Ù„Ø­Ø¬Ù… */
  cursor:pointer;
}

  </style>
</head>
<body>
<header>
  <img src="https://i.ibb.co/k2wtWBrW/unnamed.jpg" alt="Lamaa logo">
  <div>
    <h3>Lamaa â€” Admin Panel</h3>
    <small id="permNote">Notifications enabled âœ…</small>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="section-title">Current queue / Requests</div>
    <div id="list"></div>
  </div>
</div>

<button id="whOpenFab">
  <span class="icon">ğŸ•’</span><span>Ø¶Ø¨Ø· Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„</span>
</button>
<button id="reportFab">
  <span class="icon">ğŸ“Š</span><span>ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ</span>
</button>

<!-- Working hours modal -->
<div id="whBackdrop"></div>
<div id="whModal">
  <div class="wh-box">
    <div class="wh-title">
      <h4>Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø±Ø³Ù…ÙŠØ©</h4>
      <button class="wh-close" id="whCloseBtn">Ã—</button>
    </div>
    <div class="wh-mini wh-muted">
      Ù‡Ø°Ù‡ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª ØªØ³ØªØ®Ø¯Ù… Ù„ØªØ­Ø¯ÙŠØ¯ "Ù…ØªØ§Ø­" Ø£Ùˆ "Ø®Ø§Ø±Ø¬ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„" ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø²Ø¨ÙˆÙ†.
    </div>
    <div class="wh-grid" id="whGrid"></div>
    <div class="wh-actions">
      <button class="wh-btn secondary" id="whReset">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
      <button class="wh-btn primary" id="whSave">Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<!-- Daily report modal -->
<div id="reportBackdrop"></div>
<div id="reportModal">
  <div class="report-box">
    <div class="report-title">
      <h4>ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</h4>
      <button class="report-close" id="reportCloseBtn">Ã—</button>
    </div>
    <div class="report-filters">
      <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:
        <input type="date" id="reportDate">
      </label>
      <button class="report-btn load" id="reportLoadBtn">Ø¹Ø±Ø¶</button>
      <button class="report-btn pdf" id="reportPdfBtn" disabled>ØªØµØ¯ÙŠØ± PDF</button>
      <span class="wh-mini wh-muted">ÙŠØ´Ù…Ù„ ÙÙ‚Ø· Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ Ø­Ø§Ù„ØªÙ‡Ø§ <b>completed</b>.</span>
    </div>
    <div class="report-table-wrap">
      <table class="report-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</th>
            <th>Ø§Ù„Ø³Ø¹Ø±</th>
            <th>Ù…Ø¯Ø© Ø§Ù„ØªÙ†ÙÙŠØ°</th>
            <th>Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)</th>
          </tr>
        </thead>
        <tbody id="reportTableBody"></tbody>
      </table>
      <div id="reportEmpty" class="empty" style="display:none">
        Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙƒØªÙ…Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….
      </div>
    </div>
  </div>
</div>

<!-- Libs -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Firebase + auth + notifications -->
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyC_kRUAmKIFQwWK0Xrr8PeebnQbWGauu34",
    authDomain: "wash-a7ef9.firebaseapp.com",
    projectId: "wash-a7ef9",
    storageBucket: "wash-a7ef9.appspot.com",
    messagingSenderId: "244309029995",
    appId: "1:244309029995:web:b5cb0534edce26aac3ed2e"
  };
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.firestore();

  async function ensureAuth() {
    const auth = firebase.auth();
    if (auth.currentUser) return auth.currentUser;
    try { await auth.signInAnonymously(); }
    catch(e){ console.warn("[admin] anon sign-in error", e); }
    return new Promise((resolve, reject)=>{
      const to=setTimeout(()=>reject(new Error("auth-timeout")),8000);
      const unsub=firebase.auth().onAuthStateChanged(u=>{
        if(u){ clearTimeout(to);unsub();resolve(u); }
      });
    });
  }

  if ("Notification" in window) {
    Notification.requestPermission().then(p=>{
      const el=document.getElementById("permNote");
      if(!el) return;
      el.textContent = (p==="granted")
        ? "Notifications enabled âœ…"
        : "ğŸ”” Enable notifications from your browser";
    });
  }
</script>

<!-- Queue + bookings listener -->
<script>
  const list = document.getElementById("list");
  window.__ordersAll = [];

  function statusLabel(st){
    if (st === "pending") return "Status: Pending";
    if (st === "accepted") return "Status: Accepted";
    if (st === "confirmed") return "Status: Paid/Confirmed";
    if (st === "completed") return "Status: Completed";
    if (st === "rejected") return "Status: Rejected";
    return "Status: -";
  }

  function fmtShort(ts){
    if(!ts) return "-";
    const d = ts.toDate ? ts.toDate() : new Date(ts);
    return d.toLocaleString("en-GB", {
      month:"short", day:"2-digit", year:"numeric",
      hour:"2-digit", minute:"2-digit", hour12:false
    });
  }

  function renderQueue(items){
    list.innerHTML = "";
    if (!items.length){
      list.innerHTML = '<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ©.</div>';
      return;
    }

    items.forEach((x, idx)=>{
      const el = document.createElement("div");
      el.className = "card";

      const plate = `${(x.carCode || "").toString().toUpperCase()} ${x.carNumber || ""}`.trim();
      const acceptedOrPaid = (x.status === "accepted" || x.status === "confirmed");
      const pos = idx + 1;

      el.innerHTML = `
        <div class="queue-col">
          <div class="queue-badge">${pos}</div>
          <div class="queue-label">Ø§Ù„Ø¯ÙˆØ±</div>
          <div class="queue-time">${fmtShort(x.createdAtMs || x.createdAt)}</div>
        </div>

        <div class="pill">${statusLabel(x.status)}</div>

        <div class="section-title">Customer</div>
        <div class="row">
          <div><b>Phone:</b> ${x.phone || "-"}</div>
          <div><b>Car Type:</b> ${x.carType || "-"}</div>
          <div><b>Wash:</b> ${x.package || "-"}</div>
          <div><b>Price:</b> ${x.price != null ? x.price : "-"}</div>
        </div>

        <div class="section-title">Vehicle</div>
        <div class="row">
          <div><b>Plate:</b> ${plate || "-"}</div>
        </div>


<div class="section-title">Location</div>
<div class="row" style="justify-content:flex-end">
  <button class="ghost" onclick="openDirections('${x.lat || ""}','${x.lng || ""}')">
    ğŸ“ location
  </button>
</div>



        <div class="tools">
          <button
            class="${acceptedOrPaid ? "green" : "blue"}"
            id="assign-${x.id}"
            ${acceptedOrPaid ? "disabled" : ""}
            onclick="markAccepted('${x.id}', this)">
            ${acceptedOrPaid ? "Accepted/Paid" : "Accept"}
          </button>

          <button
            class="green"
            id="done-${x.id}"
            onclick="markCompleted('${x.id}', this)">
            Complete âœ“
          </button>

          <button
            class="red"
            id="reject-${x.id}"
            onclick="markRejected('${x.id}', this)">
            Reject âœ–
          </button>
        </div>
      `;

      list.appendChild(el);
    });
  }

  // subscribe to bookings
  ensureAuth().catch(()=>{}).finally(()=>{
    db.collection("bookings")
      .orderBy("createdAtMs")
      .onSnapshot(snap=>{
        const all = [];
        const queueArr = [];
        snap.forEach(doc=>{
          const d = { id: doc.id, ...doc.data() };
          if (!d) return;
          all.push(d);
          if (d.status === "pending" || d.status === "accepted" || d.status === "confirmed") {
            queueArr.push(d);
          }
        });
        window.__ordersAll = all;
        renderQueue(queueArr);
      },err=>{
        console.warn("[bookings] snapshot error", err);
        list.innerHTML = '<div class="empty">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±.</div>';
      });
  });
</script>

<!-- Actions: Accept / Complete / Reject + location -->
<script>
async function markAccepted(id, btn){
  try{
    btn.disabled = true;
    await ensureAuth().catch(()=>{});
    await db.collection("bookings").doc(id).update({
      status: "accepted"
    });
  }catch(e){
    console.warn("accept error", e);
    alert("ØªØ¹Ø°Ø± ØªÙ†ÙÙŠØ° Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨.");
    btn.disabled = false;
  }
}

async function markCompleted(id, btn){
  if (!confirm("ØªØ£ÙƒÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ØŸ")) return;
  try{
    btn.disabled = true;
    await ensureAuth().catch(()=>{});
    await db.collection("bookings").doc(id).update({
      status: "completed",
      completedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }catch(e){
    console.warn("complete error", e);
    alert("ØªØ¹Ø°Ø± ØªÙ†ÙÙŠØ° Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨.");
    btn.disabled = false;
  }
}

async function markRejected(id, btn){
  if (!confirm("ØªØ£ÙƒÙŠØ¯ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ØŸ")) return;
  try{
    btn.disabled = true;
    await ensureAuth().catch(()=>{});
    await db.collection("bookings").doc(id).update({
      status: "rejected"
    });
  }catch(e){
    console.warn("reject error", e);
    alert("ØªØ¹Ø°Ø± ØªÙ†ÙÙŠØ° Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨.");
    btn.disabled = false;
  }
}

function openDirections(lat, lng){
  if (!lat || !lng || lat === "undefined" || lng === "undefined"){
    alert("Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨.");
    return;
  }
  const url = `https://www.google.com/maps?q=${lat},${lng}`;
  window.open(url, "_blank");
}
</script>

<!-- Working hours: UI + localStorage -->
<script>
(function(){
  const DAYS = ["Ø§Ù„Ø³Ø¨Øª","Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©"];
  const STORAGE_KEY="businessHoursV1";
  const def=[
    {closed:false,p1:{from:"08:00",to:"13:00"},p2:{enabled:true,from:"16:00",to:"20:00"}},
    {closed:false,p1:{from:"08:00",to:"13:00"},p2:{enabled:true,from:"16:00",to:"20:00"}},
    {closed:false,p1:{from:"08:00",to:"13:00"},p2:{enabled:true,from:"16:00",to:"20:00"}},
    {closed:false,p1:{from:"08:00",to:"13:00"},p2:{enabled:true,from:"16:00",to:"20:00"}},
    {closed:false,p1:{from:"08:00",to:"13:00"},p2:{enabled:true,from:"16:00",to:"20:00"}},
    {closed:false,p1:{from:"08:00",to:"12:00"},p2:{enabled:false,from:"",to:""}},
    {closed:true ,p1:{from:"",to:""},         p2:{enabled:false,from:"",to:""}}
  ];
  const cloneDef=()=>JSON.parse(JSON.stringify(def));

  function load(){
    try{
      const raw=localStorage.getItem(STORAGE_KEY);
      if(!raw) return cloneDef();
      const p=JSON.parse(raw);
      if(!Array.isArray(p)||p.length!==7) return cloneDef();
      return p;
    }catch(e){return cloneDef();}
  }
  function save(h){
    try{
      localStorage.setItem(STORAGE_KEY,JSON.stringify(h));
      return true;
    }catch(e){
      alert("ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.");
      return false;
    }
  }
  function buildRow(i){
    return `
      <div class="wh-row" data-idx="${i}">
        <div class="wh-day-label">${DAYS[i]}</div>
        <div class="wh-switch">
          <input type="checkbox" class="wh-closed"><span>Ù…ØºÙ„Ù‚</span>
        </div>
        <div class="wh-period">
          <span>Ù¡</span>
          <input type="time" class="wh-p1-from"><span>â€“</span>
          <input type="time" class="wh-p1-to">
        </div>
        <div class="wh-period">
          <label><input type="checkbox" class="wh-p2-enabled"> ØªÙØ¹ÙŠÙ„ Ù¢</label>
          <input type="time" class="wh-p2-from"><span>â€“</span>
          <input type="time" class="wh-p2-to">
        </div>
      </div>`;
  }
  function renderGrid(c,h){
    c.innerHTML="";
    for(let i=0;i<7;i++) c.insertAdjacentHTML("beforeend",buildRow(i));
    c.querySelectorAll(".wh-row").forEach((row,i)=>{
      const x=h[i];
      row.querySelector(".wh-closed").checked=!!x.closed;
      row.querySelector(".wh-p1-from").value=x.p1.from||"";
      row.querySelector(".wh-p1-to").value=x.p1.to||"";
      row.querySelector(".wh-p2-enabled").checked=!!x.p2.enabled;
      row.querySelector(".wh-p2-from").value=x.p2.from||"";
      row.querySelector(".wh-p2-to").value=x.p2.to||"";
    });
  }
  function collect(c){
    const h=[];let ok=true;
    c.querySelectorAll(".wh-row").forEach((row,i)=>{
      if(!ok) return;
      const closed=row.querySelector(".wh-closed").checked;
      const p1f=row.querySelector(".wh-p1-from").value;
      const p1t=row.querySelector(".wh-p1-to").value;
      const p2e=row.querySelector(".wh-p2-enabled").checked;
      const p2f=row.querySelector(".wh-p2-from").value;
      const p2t=row.querySelector(".wh-p2-to").value;
      if(closed){
        h[i]={closed:true,p1:{from:"",to:""},p2:{enabled:false,from:"",to:""}};
        return;
      }
      if(!p1f||!p1t){alert("Ø£ÙƒÙ…Ù„ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù„Ù„ÙŠÙˆÙ…: "+DAYS[i]);ok=false;return;}
      if(p1t<=p1f){alert("Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¨Ø¹Ø¯ Ø¨Ø¯Ø§ÙŠØªÙ‡Ø§ ("+DAYS[i]+")");ok=false;return;}
      if(p2e){
        if(!p2f||!p2t){alert("Ø£ÙƒÙ…Ù„ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ù„Ù„ÙŠÙˆÙ…: "+DAYS[i]);ok=false;return;}
        if(p2t<=p2f){alert("Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¨Ø¹Ø¯ Ø¨Ø¯Ø§ÙŠØªÙ‡Ø§ ("+DAYS[i]+")");ok=false;return;}
      }
      h[i]={closed:false,p1:{from:p1f,to:p1t},p2:{enabled:p2e,from:p2f||"",to:p2t||""}};
    });
    return ok?h:null;
  }

  const whBackdrop=document.getElementById("whBackdrop");
  const whModal=document.getElementById("whModal");
  const whOpenFab=document.getElementById("whOpenFab");
  const whClose=document.getElementById("whCloseBtn");
  const whGrid=document.getElementById("whGrid");
  const whReset=document.getElementById("whReset");
  const whSave=document.getElementById("whSave");

  function openModal(){
    renderGrid(whGrid,load());
    whBackdrop.style.display="block";
    whModal.style.display="grid";
  }
  function closeModal(){
    whBackdrop.style.display="none";
    whModal.style.display="none";
  }

  whOpenFab.addEventListener("click",openModal);
  whClose.addEventListener("click",closeModal);
  whBackdrop.addEventListener("click",closeModal);
  whReset.addEventListener("click",()=>renderGrid(whGrid,cloneDef()));
  whSave.addEventListener("click",()=>{
    const h=collect(whGrid);
    if(!h) return;
    if(save(h)){
      window.__bh_save_intent=true;
      window.dispatchEvent(new CustomEvent("business-hours-updated",{detail:h}));
      closeModal();
      alert("ØªÙ… Ø­ÙØ¸ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­.");
    }
  });

  window.__getBusinessHours=()=>load();
})();
</script>

<!-- Working hours Firestore sync -->
<script>
(function(){
  const STORAGE_KEY="businessHoursV1";
  if(!(window.firebase && firebase.firestore)){return;}
  const HOURS_DOC=firebase.firestore().collection("config").doc("businessHours");
  const SV=firebase.firestore.FieldValue;
  window.__bh_cloud_ready=false;
  window.__bh_save_intent=false;

  async function pull(){
    try{
      const snap=await HOURS_DOC.get();
      const d=snap.exists && snap.data();
      if(d && Array.isArray(d.hours) && d.hours.length===7){
        localStorage.setItem(STORAGE_KEY,JSON.stringify(d.hours));
        window.__bh_cloud_ready=true;
        window.dispatchEvent(new CustomEvent("business-hours-updated",{detail:d.hours}));
      }
    }catch(e){console.warn("[admin-hours] pull error",e);}
  }

  window.addEventListener("business-hours-updated",async(ev)=>{
    if(!window.__bh_save_intent) return;
    try{
      const hours=ev && ev.detail;
      if(!(Array.isArray(hours) && hours.length===7)) return;
      await ensureAuth().catch(()=>{});
      await HOURS_DOC.set({hours,updatedAt:SV.serverTimestamp()},{merge:true});
      localStorage.setItem(STORAGE_KEY,JSON.stringify(hours));
      window.__bh_cloud_ready=true;
    }catch(e){
      console.warn("[admin-hours] push error",e);
    }finally{
      window.__bh_save_intent=false;
    }
  });

  try{
    HOURS_DOC.onSnapshot(snap=>{
      const d=snap.data && snap.data();
      if(snap.exists && d && Array.isArray(d.hours) && d.hours.length===7){
        localStorage.setItem(STORAGE_KEY,JSON.stringify(d.hours));
        window.__bh_cloud_ready=true;
        window.dispatchEvent(new CustomEvent("business-hours-updated",{detail:d.hours}));
      }
    });
  }catch(e){console.warn("[admin-hours] live sub failed",e);}

  pull();
})();
</script>

<!-- Daily report using __ordersAll -->
<script>
(function(){
  const reportFab=document.getElementById("reportFab");
  const reportBackdrop=document.getElementById("reportBackdrop");
  const reportModal=document.getElementById("reportModal");
  const reportCloseBtn=document.getElementById("reportCloseBtn");
  const reportDate=document.getElementById("reportDate");
  const reportLoadBtn=document.getElementById("reportLoadBtn");
  const reportPdfBtn=document.getElementById("reportPdfBtn");
  const reportTableBody=document.getElementById("reportTableBody");
  const reportEmpty=document.getElementById("reportEmpty");
  let currentRows=[];

  function setToday(){
    const t=new Date();
    const y=t.getFullYear();
    const m=String(t.getMonth()+1).padStart(2,"0");
    const d=String(t.getDate()).padStart(2,"0");
    reportDate.value=`${y}-${m}-${d}`;
  }

  function openModal(){
    if(!reportDate.value) setToday();
    reportBackdrop.style.display="block";
    reportModal.style.display="grid";
    loadReport();
  }
  function closeModal(){
    reportBackdrop.style.display="none";
    reportModal.style.display="none";
  }

  function readTs(v){
    if(!v) return null;
    if(v.toDate) return v.toDate();
    const d=new Date(v);
    return isNaN(d.getTime()) ? null : d;
  }

  function readPoint(o,latKey,lngKey){
    if(!o) return null;
    if(typeof o[latKey]==="number" && typeof o[lngKey]==="number"){
      return {lat:o[latKey],lng:o[lngKey]};
    }
    return null;
  }

  function haversineKm(lat1,lon1,lat2,lon2){
    const R=6371;
    const toRad=x=>x*Math.PI/180;
    const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2 +
             Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    return R*c;
  }

function formatDuration(from, to){
  if (!from || !to || to < from) return "-";
  const diff = to - from;
  const mins = Math.floor(diff / 60000);
  return `${mins} Ø¯Ù‚ÙŠÙ‚Ø©`;
}


  function loadReport(){
    const val=reportDate.value;
    if(!val){alert("Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®");return;}

    const start=new Date(val+"T00:00:00");
    const end=new Date(val+"T23:59:59");

    reportTableBody.innerHTML="";
    reportEmpty.style.display="none";
    reportPdfBtn.disabled=true;
    currentRows=[];

    const all = Array.isArray(window.__ordersAll) ? window.__ordersAll : [];
    let idx=0;

    all.forEach(d=>{
      if(!d || d.status!=="completed") return;

      const createdAt=readTs(d.createdAtMs || d.createdAt);
      const completedAt=readTs(d.completedAt);
      const ref=completedAt || createdAt;
      if(!ref || ref<start || ref>end) return;

      const plate = (d.carNumber || "") + (d.carCode || "");
      const price = d.price ?? d.totalPrice ?? "-";
      const duration = formatDuration(createdAt, completedAt);

      const lamaa = readPoint(d,"lamaaLat","lamaaLng");
      const client = readPoint(d,"clientLat","clientLng");
      let dist="-";
      if(lamaa && client){
        const km=haversineKm(lamaa.lat,lamaa.lng,client.lat,client.lng);
        if(!Number.isNaN(km)) dist=km.toFixed(2);
      }

      idx++;
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${idx}</td>
        <td>${plate || "-"}</td>
        <td>${price}</td>
        <td>${duration}</td>
        <td>${dist !== "-" ? dist : "-"}</td>`;
      reportTableBody.appendChild(tr);

      currentRows.push({
        plate: plate || "-",
        price: String(price),
        duration,
        distance: dist !== "-" ? (dist+" ÙƒÙ…") : "-"
      });
    });

    if(!currentRows.length){
      reportEmpty.style.display="block";
    }else{
      reportPdfBtn.disabled=false;
    }
  }

function exportPdf(){
  if(!currentRows.length || !window.jspdf) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"p",unit:"mm",format:"a4"});
  const dateStr = reportDate.value || "";
  doc.setFontSize(14);
  doc.text(`Daily report (completed only) - ${dateStr}`,10,12);
  doc.setFontSize(10);

  let y=22;
  doc.text("No",10,y);
  doc.text("Plate",25,y);
  doc.text("Price",75,y);
  doc.text("Duration",105,y);
  doc.text("Distance (km)",140,y);
  y+=6;

  currentRows.forEach((r,i)=>{
    if(y>280){doc.addPage();y=20;}
    doc.text(String(i+1),10,y);
    doc.text(String(r.plate),25,y);
    doc.text(String(r.price),75,y);
    doc.text(String(r.duration),105,y);
    doc.text(r.distance.replace(" ÙƒÙ…",""),140,y);
    y+=5;
  });

  doc.save(`daily-report-${dateStr}.pdf`);
}


  reportFab.addEventListener("click",openModal);
  reportBackdrop.addEventListener("click",closeModal);
  reportCloseBtn.addEventListener("click",closeModal);
  reportLoadBtn.addEventListener("click",loadReport);
  reportPdfBtn.addEventListener("click",exportPdf);
})();
</script>

</body>
</html>
