<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lamaa — Admin Panel</title>

  <style>
    :root{
      --bg1:#e6f7ff;
      --bg2:#f0fffb;
      --ink:#0f172a;
      --card:#ffffff;
      --line:#e5e7eb;
      --red:#ef4444;
      --green:#22c55e;
      --blue:#0ea5e9;
      --muted:#6b7280;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(to bottom,var(--bg1),var(--bg2));
      color:var(--ink);
    }
    header{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
    }
    header img{
      width:34px;height:34px;border-radius:10px;object-fit:cover;
    }
    header h1{margin:0;font-size:18px;font-weight:700;}
    header small{display:block;font-size:11px;color:var(--muted);}

    .wrap{padding:10px 14px 80px;}
    #list{display:flex;flex-direction:column;gap:10px;}

    .item{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .item-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      font-size:10px;
      background:#eff6ff;
      color:#1d4ed8;
    }
    .btn{
      padding:4px 9px;
      border-radius:999px;
      border:none;
      font-size:10px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .btn.blue{background:var(--blue);color:#fff;}
    .btn.red{background:var(--red);color:#fff;}
    .btn.green{background:var(--green);color:#fff;}
    .muted{color:var(--muted);font-size:10px;}

    .fab-bar{
      position:fixed;
      bottom:10px;
      right:0;left:0;
      display:flex;
      justify-content:center;
      gap:10px;
      pointer-events:none;
      z-index:9999;
    }
    .fab-btn{
      pointer-events:auto;
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:10px 18px;
      border-radius:999px;
      border:none;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 14px 40px rgba(15,23,42,.18);
    }
    .fab-work{background:var(--blue);color:#fff;}
    .fab-report{background:#111827;color:#e5e7eb;}
    .fab-btn svg{width:16px;height:16px;}

    .wh-backdrop,.rpt-backdrop{
      position:fixed;inset:0;
      background:rgba(15,23,42,.30);
      display:none;
      z-index:9997;
    }
    .wh-modal,.rpt-modal{
      position:fixed;
      inset-inline:10px;
      bottom:80px;
      margin:auto;
      max-width:600px;
      background:#fff;
      border-radius:18px;
      padding:14px;
      box-shadow:0 18px 50px rgba(15,23,42,.25);
      display:none;
      z-index:9998;
    }
    .modal-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
    }
    .modal-head h3{margin:0;font-size:16px;font-weight:700;}
    .modal-head small{display:block;font-size:11px;color:var(--muted);}
    .modal-close{
      border:none;background:transparent;
      font-size:20px;cursor:pointer;color:#9ca3af;
    }

    table{width:100%;border-collapse:collapse;font-size:11px;}
    th,td{
      padding:6px;
      border-bottom:1px solid var(--line);
      text-align:right;
      white-space:nowrap;
    }
    th{background:#f9fafb;font-weight:600;}
  </style>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
<header>
  <img src="https://i.ibb.co/NS9TWB8/lamaa-logo.png" alt="Lamaa">
  <div>
    <h1>Lamaa — Admin Panel</h1>
    <small>Notifications enabled ✅</small>
  </div>
</header>

<div class="wrap">
  <div id="list"></div>
</div>

<!-- نافذة التقارير -->
<div class="rpt-backdrop" id="rptBackdrop" onclick="toggleReport(false)"></div>
<div class="rpt-modal" id="rptModal">
  <div class="modal-head">
    <div>
      <h3>التقارير اليومية والشهرية</h3>
      <small>التقارير تعتمد فقط على الطلبات التي حالتها <b>completed</b>.</small>
    </div>
    <button class="modal-close" onclick="toggleReport(false)">×</button>
  </div>

  <div style="display:flex;flex-wrap:wrap;gap:14px;margin:10px 0;">
    <div>
      <div class="muted" style="margin-bottom:4px;">تقرير يومي</div>
      <input type="date" id="rptDay"
             style="padding:6px 8px;border-radius:10px;border:1px solid var(--line);min-width:150px;">
      <button class="btn blue" style="margin-top:4px;" onclick="loadDailyReport()">عرض اليوم</button>
    </div>
    <div>
      <div class="muted" style="margin-bottom:4px;">تقرير شهري</div>
      <input type="month" id="rptMonth"
             style="padding:6px 8px;border-radius:10px;border:1px solid var(--line);min-width:150px;">
      <button class="btn blue" style="margin-top:4px;" onclick="loadMonthlyReport()">عرض الشهر</button>
    </div>
  </div>

  <div style="overflow-x:auto;">
    <table id="rptTable">
      <thead>
      <tr>
        <th>وقت الإكمال</th>
        <th>نوع الغسيل</th>
        <th>السعر (OMR)</th>
        <th>المدة (دقيقة)</th>
        <th>المسافة من نقطة استلام الطلب (كم)</th>
      </tr>
      </thead>
      <tbody>
      <tr><td colspan="5" style="color:var(--muted);">اختر يومًا أو شهرًا ثم اضغط عرض.</td></tr>
      </tbody>
    </table>
  </div>
  <div id="rptSummary" class="muted" style="margin-top:4px;"></div>
</div>

<!-- شريط الأزرار -->
<div class="fab-bar">
  <button class="fab-btn fab-work" onclick="toggleWorkHours(true)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M12 7v5l3 2"></path>
    </svg>
    أوقات العمل
  </button>

  <button class="fab-btn fab-report" onclick="toggleReport()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path d="M4 19V9"></path>
      <path d="M10 19V5"></path>
      <path d="M16 19V12"></path>
      <path d="M3 19h18"></path>
    </svg>
    التقرير
  </button>
</div>

<!-- نافذة أوقات العمل: ضع نموذجك الفعلي هنا -->
<div class="wh-backdrop" id="whBackdrop" onclick="toggleWorkHours(false)"></div>
<div class="wh-modal" id="whModal">
  <div class="modal-head">
    <div>
      <h3>إعداد أوقات العمل</h3>
      <small>ضع هنا نفس حقول أوقات العمل التي كنت تستخدمها.</small>
    </div>
    <button class="modal-close" onclick="toggleWorkHours(false)">×</button>
  </div>
</div>

<script>
  // Firebase init
  var db = null;
  (function initFirebase(){
    const firebaseConfig = {
      apiKey: "AIzaSyC_kRUAmKIFQwWK0Xrr8PeebnQbWGauu34",
      authDomain: "wash-a7ef9.firebaseapp.com",
      projectId: "wash-a7ef9",
      storageBucket: "wash-a7ef9.firebasestorage.app",
      messagingSenderId: "244309029995",
      appId: "1:244309029995:web:b5cb0534edce26aac3ed2e"
    };
    if (!firebase.apps.length){
      firebase.initializeApp(firebaseConfig);
    }
    db = firebase.firestore();
  })();

  // ========== Helpers ==========
  function washLabel(p){
    if (!p) return 'غير محدد';
    const v = (''+p).toLowerCase();
    if (v.includes('full')) return 'غسيل كامل';
    if (v.includes('inside')) return 'غسيل داخلي';
    if (v.includes('outside')) return 'غسيل خارجي';
    return p;
  }
  function fmtTime(d){
    const dt = (d instanceof Date)? d : new Date(d);
    if (isNaN(dt.getTime())) return '—';
    return dt.toLocaleString('ar-EG',{hour:'2-digit',minute:'2-digit',hour12:true});
  }
  function getCompletedDate(b){
    if (b.completedAt && typeof b.completedAt.toDate === 'function'){
      try{
        const d = b.completedAt.toDate();
        if (!isNaN(d.getTime())) return d;
      }catch(e){}
    }
    if (typeof b.completedAtMs === 'number'){
      const d = new Date(b.completedAtMs);
      if (!isNaN(d.getTime())) return d;
    }
    if (typeof b.completedAt === 'string'){
      const t = Date.parse(b.completedAt);
      if (!isNaN(t)) return new Date(t);
    }
    return null;
  }
  function getCreatedDate(b){
    if (b.createdAt && typeof b.createdAt.toDate === 'function'){
      try{
        const d = b.createdAt.toDate();
        if (!isNaN(d.getTime())) return d;
      }catch(e){}
    }
    if (typeof b.createdAt === 'number'){
      const d = new Date(b.createdAt);
      if (!isNaN(d.getTime())) return d;
    }
    if (typeof b.createdAt === 'string'){
      const t = Date.parse(b.createdAt);
      if (!isNaN(t)) return new Date(t);
    }
    return new Date(0);
  }
  function ymdLocal(d){
    const off = d.getTimezoneOffset()*60000;
    const local = new Date(d.getTime() - off);
    return local.toISOString().slice(0,10);
  }
  function ymLocal(d){
    const off = d.getTimezoneOffset()*60000;
    const local = new Date(d.getTime() - off);
    return local.toISOString().slice(0,7);
  }
  function haversineKm(lat1,lon1,lat2,lon2){
    const R = 6371;
    const toRad = x => x*Math.PI/180;
    const dLat = toRad(lat2-lat1);
    const dLon = toRad(lon2-lon1);
    const a =
      Math.sin(dLat/2)**2 +
      Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    const c = 2*Math.atan2(Math.sqrt(1-a),Math.sqrt(a));
    return R*c;
  }
  function computeDistanceFromPickup(b){
    const sLat = parseFloat(b.pickupLat);
    const sLng = parseFloat(b.pickupLng);
    const cLat = parseFloat(b.lat);
    const cLng = parseFloat(b.lng);
    if (!Number.isFinite(sLat) || !Number.isFinite(sLng)) return null;
    if (!Number.isFinite(cLat) || !Number.isFinite(cLng)) return null;
    return haversineKm(sLat,sLng,cLat,cLng);
  }
  function computeDurationMinutes(b){
    const start = (typeof b.createdAtMs === 'number')
      ? b.createdAtMs
      : (b.createdAt ? Date.parse(b.createdAt) : null);
    const endDate = getCompletedDate(b);
    if (!start || !endDate) return null;
    const diff = endDate.getTime() - start;
    if (diff <= 0) return null;
    return diff / 60000;
  }

  // ========== تحميل الطلبات بدون orderBy ==========
  async function loadBookings(){
    const list = document.getElementById('list');
    list.innerHTML = '<div class="item muted">Loading bookings...</div>';
    if (!db){
      list.innerHTML = '<div class="item" style="color:#b91c1c;">Firebase غير مهيأ.</div>';
      return;
    }
    try{
      const snap = await db.collection('bookings')
        .where('status','in',['pending','accepted','paid'])
        .limit(200)
        .get();

      const rows = [];
      snap.forEach(doc => rows.push({ id: doc.id, ...doc.data() }));

      rows.sort((a,b)=> getCreatedDate(b) - getCreatedDate(a));

      if (!rows.length){
        list.innerHTML = '<div class="item muted">No (pending/accepted/paid) bookings.</div>';
        return;
      }

      list.innerHTML = '';
      rows.forEach(b=>{
        const when = b.createdAt ? fmtTime(getCreatedDate(b)) : '—';
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML =
          '<div class="item-header">'+
            '<div><strong>'+(b.name||"عميل")+'</strong>'+
            '<div class="muted">'+(b.phone||'')+'</div></div>'+
            '<div class="badge">'+(b.status||'')+'</div>'+
          '</div>'+
          '<div class="muted">الوقت: '+when+' — نوع الغسيل: '+washLabel(b.package)+'</div>';
        list.appendChild(div);
      });
    }catch(e){
      list.innerHTML =
        '<div class="item" style="color:#b91c1c;">خطأ في تحميل الطلبات: '+e.message+'</div>';
    }
  }

  // ========== نوافذ أوقات العمل / التقرير مع رقم سري ==========
  let rptUnlocked = false; // لا يتم طلبه مرة أخرى بعد نجاحه

  function toggleWorkHours(show){
    const b = document.getElementById('whBackdrop');
    const m = document.getElementById('whModal');
    const s = (typeof show === 'boolean') ? show : (m.style.display !== 'block');
    b.style.display = s ? 'block' : 'none';
    m.style.display = s ? 'block' : 'none';
  }

  function toggleReport(show){
    const b = document.getElementById('rptBackdrop');
    const m = document.getElementById('rptModal');
    const isOpen = (m.style.display === 'block');
    const target = (typeof show === 'boolean') ? show : !isOpen;

    // عند الفتح فقط نتحقق من الرقم السري
    if (target && !isOpen && !rptUnlocked){
      const code = prompt('أدخل الرقم السري لفتح التقارير:');
      if (code !== '9133'){
        alert('رقم سري غير صحيح');
        return;
      }
      rptUnlocked = true;
    }

    b.style.display = target ? 'block' : 'none';
    m.style.display = target ? 'block' : 'none';

    if (target){
      const dayInput = document.getElementById('rptDay');
      if (!dayInput.value){
        dayInput.value = new Date().toISOString().slice(0,10);
      }
      loadDailyReport();
    }
  }

  // ========== التقارير ==========
  async function loadDailyReport(){
    const input = document.getElementById('rptDay');
    const tbody = document.querySelector('#rptTable tbody');
    const summary = document.getElementById('rptSummary');
    const day = input.value || new Date().toISOString().slice(0,10);
    input.value = day;

    tbody.innerHTML =
      '<tr><td colspan="5" style="color:var(--muted);">جاري تحميل تقرير اليوم...</td></tr>';
    summary.textContent = '';

    if (!db){
      tbody.innerHTML =
        '<tr><td colspan="5" style="color:#b91c1c;">Firebase غير مهيأ.</td></tr>';
      return;
    }

    try{
      const snap = await db.collection('bookings')
        .where('status','==','completed')
        .get();

      const all = [];
      snap.forEach(d => all.push({ id:d.id, ...d.data() }));

      const filtered = all.filter(b=>{
        if (b.completedDay === day) return true;
        const dt = getCompletedDate(b);
        return dt ? (ymdLocal(dt) === day) : false;
      });

      renderReport(filtered, 'تقرير يوم '+day);
    }catch(e){
      tbody.innerHTML =
        '<tr><td colspan="5" style="color:#b91c1c;">تعذر تحميل تقرير اليوم: '+e.message+'</td></tr>';
    }
  }

  async function loadMonthlyReport(){
    const input = document.getElementById('rptMonth');
    const tbody = document.querySelector('#rptTable tbody');
    const summary = document.getElementById('rptSummary');
    const ymVal = input.value || new Date().toISOString().slice(0,7);
    input.value = ymVal;

    tbody.innerHTML =
      '<tr><td colspan="5" style="color:var(--muted);">جاري تحميل تقرير الشهر...</td></tr>';
    summary.textContent = '';

    if (!db){
      tbody.innerHTML =
        '<tr><td colspan="5" style="color:#b91c1c;">Firebase غير مهيأ.</td></tr>';
      return;
    }

    try{
      const snap = await db.collection('bookings')
        .where('status','==','completed')
        .get();

      const all = [];
      snap.forEach(d => all.push({ id:d.id, ...d.data() }));

      const filtered = all.filter(b=>{
        if (b.completedMonth === ymVal) return true;
        const dt = getCompletedDate(b);
        return dt ? (ymLocal(dt) === ymVal) : false;
      });

      renderReport(filtered, 'تقرير شهر '+ymVal);
    }catch(e){
      tbody.innerHTML =
        '<tr><td colspan="5" style="color:#b91c1c;">تعذر تحميل تقرير الشهر: '+e.message+'</td></tr>';
    }
  }

  function renderReport(items, label){
    const tbody = document.querySelector('#rptTable tbody');
    const summary = document.getElementById('rptSummary');
    tbody.innerHTML = '';

    if (!items.length){
      tbody.innerHTML =
        '<tr><td colspan="5" style="color:var(--muted);">لا توجد طلبات مكتملة لـ '+label+'.</td></tr>';
      summary.textContent = '';
      return;
    }

    let totalPrice = 0;
    let totalDuration = 0, cDur = 0;
    let totalDist = 0, cDist = 0;

    items.forEach(b=>{
      const dt = getCompletedDate(b);
      const duration = computeDurationMinutes(b);
      const dist = computeDistanceFromPickup(b);
      const price = Number(b.price || 0);

      totalPrice += price;
      if (duration != null){ totalDuration += duration; cDur++; }
      if (dist != null){ totalDist += dist; cDist++; }

      const tr = document.createElement('tr');
      tr.innerHTML =
        '<td>'+(dt?fmtTime(dt):'—')+'</td>'+
        '<td>'+washLabel(b.package)+'</td>'+
        '<td>'+price.toFixed(3)+'</td>'+
        '<td>'+(duration!=null?duration.toFixed(1):'—')+'</td>'+
        '<td>'+(dist!=null?dist.toFixed(2):'—')+'</td>';
      tbody.appendChild(tr);
    });

    const avgDur = cDur ? (totalDuration / cDur) : 0;
    const avgDist = cDist ? (totalDist / cDist) : 0;

    summary.innerHTML =
      label+
      ' — عدد الطلبات: '+items.length+
      ' | إجمالي المبالغ: '+totalPrice.toFixed(3)+' OMR'+
      ' | متوسط المدة: '+avgDur.toFixed(1)+' دقيقة'+
      ' | إجمالي المسافة: '+totalDist.toFixed(2)+' كم'+
      ' | متوسط المسافة: '+avgDist.toFixed(2)+' كم';
  }

  loadBookings();
</script>
</body>
</html>
