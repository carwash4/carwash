<script>
(function(){
  const DAYS = ["السبت","الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة"];
  const STORAGE_KEY="businessHoursV1";
  const def=[
    {closed:false,p1:{from:"08:00",to:"13:00"},p2:{enabled:true,from:"16:00",to:"20:00"}},
    {closed:false,p1:{from:"08:00",to:"13:00"},p2:{enabled:true,from:"16:00",to:"20:00"}},
    {closed:false,p1:{from:"08:00",to:"13:00"},p2:{enabled:true,from:"16:00",to:"20:00"}},
    {closed:false,p1:{from:"08:00",to:"13:00"},p2:{enabled:true,from:"16:00",to:"20:00"}},
    {closed:false,p1:{from:"08:00",to:"13:00"},p2:{enabled:true,from:"16:00",to:"20:00"}},
    {closed:false,p1:{from:"08:00",to:"12:00"},p2:{enabled:false,from:"",to:""}},
    {closed:true ,p1:{from:"",to:""},         p2:{enabled:false,from:"",to:""}}
  ];
  const cloneDef=()=>JSON.parse(JSON.stringify(def));

  // قراءة من localStorage (تدعم الشكل القديم والجديد)
  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return cloneDef();
      const p = JSON.parse(raw);

      if (Array.isArray(p) && p.length === 7) return p;               // شكل قديم
      if (p && Array.isArray(p.hours) && p.hours.length === 7)        // شكل جديد
        return p.hours;

      return cloneDef();
    }catch(e){
      return cloneDef();
    }
  }

  // حفظ في localStorage مع وقت آخر تعديل
  function save(hours){
    try{
      const payload = {
        hours,
        updatedAtMs: Date.now()
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      return true;
    }catch(e){
      alert("تعذر الحفظ في هذا المتصفح.");
      return false;
    }
  }

  function buildRow(i){
    return `
      <div class="wh-row" data-idx="${i}">
        <div class="wh-day-label">${DAYS[i]}</div>
        <div class="wh-switch">
          <input type="checkbox" class="wh-closed"><span>مغلق</span>
        </div>
        <div class="wh-period">
          <span>١</span>
          <input type="time" class="wh-p1-from"><span>–</span>
          <input type="time" class="wh-p1-to">
        </div>
        <div class="wh-period">
          <label><input type="checkbox" class="wh-p2-enabled"> تفعيل ٢</label>
          <input type="time" class="wh-p2-from"><span>–</span>
          <input type="time" class="wh-p2-to">
        </div>
      </div>`;
  }

  function renderGrid(c,h){
    c.innerHTML="";
    for(let i=0;i<7;i++) c.insertAdjacentHTML("beforeend",buildRow(i));
    c.querySelectorAll(".wh-row").forEach((row,i)=>{
      const x=h[i];
      row.querySelector(".wh-closed").checked=!!x.closed;
      row.querySelector(".wh-p1-from").value=x.p1.from||"";
      row.querySelector(".wh-p1-to").value=x.p1.to||"";
      row.querySelector(".wh-p2-enabled").checked=!!x.p2.enabled;
      row.querySelector(".wh-p2-from").value=x.p2.from||"";
      row.querySelector(".wh-p2-to").value=x.p2.to||"";
    });
  }

  function collect(c){
    const h=[];let ok=true;
    c.querySelectorAll(".wh-row").forEach((row,i)=>{
      if(!ok) return;
      const closed=row.querySelector(".wh-closed").checked;
      const p1f=row.querySelector(".wh-p1-from").value;
      const p1t=row.querySelector(".wh-p1-to").value;
      const p2e=row.querySelector(".wh-p2-enabled").checked;
      const p2f=row.querySelector(".wh-p2-from").value;
      const p2t=row.querySelector(".wh-p2-to").value;

      if(closed){
        h[i]={closed:true,p1:{from:"",to:""},p2:{enabled:false,from:"",to:""}};
        return;
      }
      if(!p1f||!p1t){alert("أكمل الفترة الأولى لليوم: "+DAYS[i]);ok=false;return;}
      if(p1t<=p1f){alert("نهاية الفترة الأولى يجب أن تكون بعد بدايتها ("+DAYS[i]+")");ok=false;return;}
      if(p2e){
        if(!p2f||!p2t){alert("أكمل الفترة الثانية لليوم: "+DAYS[i]);ok=false;return;}
        if(p2t<=p2f){alert("نهاية الفترة الثانية يجب أن تكون بعد بدايتها ("+DAYS[i]+")");ok=false;return;}
      }
      h[i]={closed:false,p1:{from:p1f,to:p1t},p2:{enabled:p2e,from:p2f||"",to:p2t||""}};
    });
    return ok?h:null;
  }

  const whBackdrop=document.getElementById("whBackdrop");
  const whModal=document.getElementById("whModal");
  const whOpenFab=document.getElementById("whOpenFab");
  const whClose=document.getElementById("whCloseBtn");
  const whGrid=document.getElementById("whGrid");
  const whReset=document.getElementById("whReset");
  const whSave=document.getElementById("whSave");

  function openModal(){
    renderGrid(whGrid,load());
    whBackdrop.style.display="block";
    whModal.style.display="grid";
  }
  function closeModal(){
    whBackdrop.style.display="none";
    whModal.style.display="none";
  }

  whOpenFab.addEventListener("click",openModal);
  whClose.addEventListener("click",closeModal);
  whBackdrop.addEventListener("click",closeModal);
  whReset.addEventListener("click",()=>renderGrid(whGrid,cloneDef()));
  whSave.addEventListener("click",()=>{
    const h=collect(whGrid);
    if(!h) return;
    if(save(h)){
      window.__bh_save_intent = true; // إشارة لنجاح الحفظ المحلي
      window.dispatchEvent(new CustomEvent("business-hours-updated",{detail:h}));
      closeModal();
      alert("تم حفظ أوقات العمل بنجاح.");
    }
  });

  window.__getBusinessHours = ()=>load();
})();
</script>
