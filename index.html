<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لمعة — غسيل سيارات متنقل</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

  <style>
    :root{
      --bg1:#e6f7ff; --bg2:#f0fffb; --ink:#0f1a2b;
      --brand:#00aaff; --brand2:#00d2a0;
      --muted:#5f7aa3; --card:#ffffff; --line:#e6eef8;
    }
    *{box-sizing:border-box}
    body { font-family:"Tajawal",sans-serif; background:radial-gradient(1200px 700px at 80% -10%,var(--bg1),transparent 60%),linear-gradient(180deg,var(--bg1),var(--bg2)); color:var(--ink); margin:0; }
    .hero { text-align:center; padding:28px 16px 18px; background:linear-gradient(135deg,rgba(0,170,255,.12),rgba(0,210,160,.10)),linear-gradient(180deg,#ffffffaa,#ffffff66); border-bottom:1px solid var(--line); }
    .hero h1{margin:8px 0 6px;font-size:2.2rem}
    .hero p{margin:0;color:var(--muted)}
    .formWrap{max-width:920px;margin:14px auto;background:var(--card);padding:20px;border-radius:14px;border:1px solid var(--line);box-shadow:0 10px 28px rgba(0,0,0,.06)}
    fieldset{border:1px dashed var(--line);border-radius:12px;padding:14px;margin-bottom:12px}
    legend{color:var(--muted)}
    input,select{width:100%;padding:12px;margin-bottom:10px;border-radius:10px;border:1px solid var(--line);background:#f8fbff;color:var(--ink);outline:none}
    input:focus,select:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(0,170,255,.15)}
    .row-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:640px){.row-2{grid-template-columns:1fr}}
    .price{font-size:1.25rem;font-weight:800;color:var(--brand)}
    .inline-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .btn{padding:12px 18px;border:none;border-radius:12px;cursor:pointer;font-weight:800}
    .btn.primary{background:var(--brand);color:#fff}
    .btn.success{background:var(--brand2);color:#003326}
    .btn.light{background:#eef6ff;color:#0f3c6e}
    #statusBanner{background:#e9fff6;border:1px solid #c3f5e5;color:#085a46}
    .map-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999}
    .map-card{width:min(94vw,840px);background:var(--card);border-radius:14px;padding:12px;box-shadow:0 16px 40px rgba(0,0,0,.18);border:1px solid var(--line)}
    #map{width:100%;height:440px;border-radius:12px}
    .map-actions{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;align-items:center}
    .hint{color:var(--muted)}
    footer{text-align:center;color:var(--muted);padding:10px 0 24px}
    .subhint{font-size:.9rem;color:var(--muted);margin-top:-6px}
    .badge{display:inline-block;background:#eef6ff;border:1px solid #d7e8ff;border-radius:999px;padding:6px 10px;font-weight:700}
    .list{display:grid;gap:10px}
    .item{border:1px dashed var(--line);border-radius:12px;padding:10px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <section class="hero">
    <img src="https://i.ibb.co/k2wtWBrW/unnamed.jpg" alt="شعار لمعة" style="max-width:160px;display:block;margin:0 auto 8px;border-radius:14px;box-shadow:0 4px 14px rgba(0,0,0,.06);">
    <h1>احجز غسيل سيارتك الآن</h1>
    <p>اختر نوع الغسيل، حدّد موقع السيارة، وثبّت الحجز فورًا.</p>
  </section>

  <div id="statusBanner" class="formWrap" style="display:none;">
    <p id="statusText" style="margin:0;font-weight:800;"></p>
  </div>

  <section class="container">
    <form class="formWrap" id="bookingForm">
      <!-- (1) رقم الهاتف -->
      <fieldset><legend>رقم الهاتف</legend>
        <input id="phone" name="phone" type="tel" required placeholder="9xxxxxxxx" inputmode="tel" autocomplete="tel">
      </fieldset>

      <!-- (2) نوع السيارة -->
      <fieldset><legend>نوع السيارة</legend>
        <select id="carType" name="carType" required>
          <option value="">اختر نوع السيارة</option>
          <option value="صالون">صالون</option>
          <option value="فورويل">فورويل</option>
        </select>
      </fieldset>

      <!-- (2.1 & 2.2) بيانات اللوحة: رقم + رمز (إنجليزي) -->
      <fieldset><legend>بيانات لوحة السيارة</legend>
        <div class="row-2">
          <div>
            <label for="carNumber" class="subhint">رقم اللوحة</label>
            <input id="carNumber" name="carNumber" type="text" required placeholder="e.g., 1234" pattern="\d{1,6}" inputmode="numeric">
          </div>
          <div>
            <label for="carCode" class="subhint">رمز/حرف اللوحة (إنجليزي)</label>
            <input id="carCode" name="carCode" type="text" required placeholder="e.g., A" pattern="[A-Za-z]{1,2}" title="أدخل حرفًا إنجليزيًا واحدًا أو حرفين">
          </div>
        </div>
      </fieldset>

      <!-- (3) نوع الغسيل -->
      <fieldset><legend>نوع الغسيل</legend>
        <select id="package" name="package" required>
          <option value="">اختر نوع الغسيل</option>
          <option value="external">غسيل خارجي</option>
          <option value="both">غسيل خارجي وداخلي</option>
        </select>
      </fieldset>

      <!-- (4) موقع السيارة -->
      <fieldset><legend>موقع السيارة</legend>
        <input id="address" type="text" placeholder="انقر لاختيار الموقع على الخريطة" readonly required>
        <input type="hidden" id="lat" name="lat"><input type="hidden" id="lng" name="lng">
      </fieldset>

      <div id="priceSection" class="inline-actions">
        <p class="price">السعر: <span id="priceValue">0.00</span> ر.ع</p>
        <button class="btn success" type="button" id="confirmBtn" disabled>تأكيد الحجز</button>
      </div>
      <p class="muted" id="queueHint" style="display:none;margin:6px 2px 0;"></p>
    </form>
  </section>

  <!-- لوحة الموظف (تظهر فقط مع ?staff=1) -->
  <section class="formWrap" id="staffPanel" style="display:none;">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px">
      <h2 style="margin:0">لوحة الموظف</h2>
      <span class="badge" id="activeCount">القائمة النشطة: 0</span>
    </div>
    <div class="list" id="activeList"></div>
  </section>

  <!-- نافذة الخريطة -->
  <div class="map-backdrop" id="mapModal" aria-hidden="true">
    <div class="map-card">
      <div id="map" role="application" aria-label="خريطة اختيار موقع السيارة"></div>
      <div class="map-actions">
        <button class="btn" type="button" id="useMyLocationBtn">📍 استخدام موقعي الحالي</button>
        <button class="btn success" type="button" id="confirmLocationBtn">✅ تأكيد الموقع</button>
        <button class="btn" type="button" id="closeMapBtn">✖️ إغلاق</button>
        <span class="hint" id="pickedCoords"></span>
      </div>
    </div>
  </div>

  <!-- قسم الدفع -->
  <div class="formWrap" id="paymentSection" style="display:none;">
    <h2 style="margin-top:0">إتمام الدفع</h2>
    <p style="color:var(--muted)">الرجاء تحويل المبلغ على رقم 99808079.</p>
    <div class="inline-actions"><button class="btn primary" id="paymentButton" type="button">تم الدفع</button></div>
  </div>

  <footer>© لمعة — خدمة غسيل سيارات متنقلة</footer>

  <!-- مكتبات -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <script>
    /* ====== Firebase ====== */
    const firebaseConfig = {
      apiKey: "AIzaSyC_kRUAmKIFQwWK0Xrr8PeebnQbWGauu34",
      authDomain: "wash-a7ef9.firebaseapp.com",
      projectId: "wash-a7ef9",
      storageBucket: "wash-a7ef9.firebasestorage.app",
      messagingSenderId: "244309029995",
      appId: "1:244309029995:web:b5cb0534edce26aac3ed2e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* ====== متغيرات عامة ====== */
    let map, marker, lastLatLng = null;
    let currentBookingId = null;
    let unsubscribeBooking = null;
    const ACTIVE_STATUSES = ['pending','confirmed','accepted']; // تدخل في قائمة الانتظار
    const DONE_STATUSES = ['completed','rejected','declined','canceled']; // تُستبعد من الانتظار

    $(function () {
      $('#address').on('click', openMapModal);
      $('#useMyLocationBtn').on('click', useMyCurrentLocation);
      $('#confirmLocationBtn').on('click', confirmPickedLocation);
      $('#closeMapBtn').on('click', closeMapModal);

      // تحديث السعر عند تغيير نوع الغسيل أو نوع السيارة
      $('#package').on('change', updatePrice);
      $('#carType').on('change', updatePrice);
      updatePrice();

      document.getElementById('confirmBtn').addEventListener('click', onConfirmBooking);
      document.getElementById('paymentButton').addEventListener('click', onCompletePayment);

      ['phone','package','carType','carNumber','carCode'].forEach(id => {
        document.getElementById(id).addEventListener('input', toggleConfirmEnabled);
        document.getElementById(id).addEventListener('change', toggleConfirmEnabled);
      });

      // إجبار رمز اللوحة على الإنجليزية وبأحرف كبيرة فقط
      const codeInput = document.getElementById('carCode');
      codeInput.addEventListener('input', (e) => {
        e.target.value = e.target.value.toUpperCase().replace(/[^A-Z]/g,'');
      });

      // تفعيل لوحة الموظف عند ?staff=1
      const params = new URLSearchParams(location.search);
      if (params.get('staff') === '1') {
        document.getElementById('staffPanel').style.display = 'block';
        subscribeActiveList();
      }
    });

    // ✅ تسعير بحسب نوع السيارة + نوع الغسيل
    function calcPrice(pkg, car) {
  const bump = 0.30; // global increase per price
  if (!pkg || !car) return 0;
  if (car === 'صالون') {
    if (pkg === 'external') return 1.00 + bump; // was 1.00
    if (pkg === 'both')     return 1.50 + bump; // was 1.50
  }
  if (car === 'فورويل') {
    if (pkg === 'external') return 1.50 + bump; // was 1.50
    if (pkg === 'both')     return 2.00 + bump; // was 2.00
  }
  return 0;
}
function updatePrice() {
      const pkg  = document.getElementById('package').value;
      const car  = document.getElementById('carType').value;
      const price = calcPrice(pkg, car);
      document.getElementById('priceValue').innerText = price.toFixed(2);
      toggleConfirmEnabled();
    }

    function toggleConfirmEnabled() {
      const phone = document.getElementById('phone').value.trim();
      const pkg   = document.getElementById('package').value;
      const car   = document.getElementById('carType').value;
      const carNumber = (document.getElementById('carNumber')?.value || '').trim();
      const carCode   = (document.getElementById('carCode')?.value || '').trim();
      const price = calcPrice(pkg, car);
      const hasLocation = !!document.getElementById('lat').value && !!document.getElementById('lng').value;
      document.getElementById('confirmBtn').disabled = !(price > 0 && phone && car && carNumber && carCode && hasLocation);
    }

    /* ====== الخريطة ====== */
    function openMapModal() {
      const modal = document.getElementById('mapModal');
      modal.style.display = 'flex';
      setTimeout(() => {
        if (!map) {
          map = L.map('map');
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);
          map.setView([23.5880, 58.3829], 12);
          tryLocateAndDraw();
          map.on('click', e => setMarker(e.latlng));
        }
        setTimeout(() => map.invalidateSize(), 60);
      }, 0);
    }

    function tryLocateAndDraw() {
      if (!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(pos => {
        const userLatLng = [pos.coords.latitude, pos.coords.longitude];
        map.setView(userLatLng, 15);
        const blueIcon = L.divIcon({
          html: '<div style="width:20px;height:20px;background:#4285F4;border:3px solid white;border-radius:50%;box-shadow:0 0 6px rgba(66,133,244,0.8);"></div>',
          className: ""
        });
        L.marker(userLatLng, { icon: blueIcon }).addTo(map).bindPopup("موقعي الحالي").openPopup();
        L.circle(userLatLng, { radius: 120, color: '#4285F4', fillColor: '#4285F4', fillOpacity: 0.2 }).addTo(map);
      }, () => {});
    }

    function setMarker(latlng) {
      lastLatLng = latlng;
      if (!marker) {
        marker = L.marker(latlng, { draggable: true }).addTo(map);
        marker.on('dragend', () => { lastLatLng = marker.getLatLng(); updatePickedCoordsText(); });
      } else {
        marker.setLatLng(latlng);
      }
      updatePickedCoordsText();
    }

    function updatePickedCoordsText() {
      if (!lastLatLng) return;
      document.getElementById('pickedCoords').textContent =
        `الموقع المحدد: ${lastLatLng.lat.toFixed(6)}, ${lastLatLng.lng.toFixed(6)}`;
    }

    function confirmPickedLocation() {
      if (!lastLatLng) { alert('انقر على الخريطة لتحديد موقع السيارة.'); return; }
      document.getElementById('lat').value = lastLatLng.lat.toFixed(6);
      document.getElementById('lng').value = lastLatLng.lng.toFixed(6);
      document.getElementById('address').value = `${lastLatLng.lat.toFixed(6)}, ${lastLatLng.lng.toFixed(6)}`;
      toggleConfirmEnabled();
      closeMapModal();
    }

    function closeMapModal() { document.getElementById('mapModal').style.display = 'none'; }

    // يحدد الموقع ويغلق النافذة مباشرة
    function useMyCurrentLocation() {
      if (!navigator.geolocation) {
        alert('المتصفح لا يدعم تحديد الموقع.');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          const ll = { lat: pos.coords.latitude, lng: pos.coords.longitude };

          if (map) {
            map.setView([ll.lat, ll.lng], 16);
            setMarker(ll);
          }

          document.getElementById('lat').value = ll.lat.toFixed(6);
          document.getElementById('lng').value = ll.lng.toFixed(6);
          document.getElementById('address').value = `${ll.lat.toFixed(6)}, ${ll.lng.toFixed(6)}`;
          updatePickedCoordsText();
          toggleConfirmEnabled();

          closeMapModal();
        },
        err => {
          console.error('خطأ تحديد الموقع:', err);
          alert('تعذّر الحصول على موقعك. تأكد من تفعيل GPS ومنح الصلاحية للمتصفح.');
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }

    /* ====== بانر الحالة والاشتراك ====== */
    function showBanner(msg) {
      const b = document.getElementById('statusBanner');
      const t = document.getElementById('statusText');
      t.textContent = msg;
      b.style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function subscribeToBooking(id) {
      if (unsubscribeBooking) unsubscribeBooking();
      unsubscribeBooking = db.collection('bookings').doc(id).onSnapshot(async snap => {
        const data = snap.data();
        if (!data) return;
        // تحديث رقم الدور عند أي تغيير في الحجز
        await updateQueuePositionBanner(id);

        if (data.status === 'accepted') {
          showBanner('تم استلام طلبك وسيقوم الفريق بالتوجه للموقع لبدء العمل في تنظيف السيارة');
        }
        if (data.status === 'completed') {
          showBanner('تم إنجاز الخدمة، شكرًا لاختيارك لنا.');
        }
        if (data.status === 'rejected') {
          showBanner('نعتذر، تم إلغاء الطلب لعدم إتمام الدفع.');
        }
      });
    }

    async function updateQueuePositionBanner(bookingId) {
      try {
        const snap = await db.collection('bookings')
          .orderBy('createdAtMs')
          .get();
        const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        const actives = docs.filter(b => ACTIVE_STATUSES.includes(b.status));
        const index = actives.findIndex(d => d.id === bookingId);
        if (index >= 0) {
          const position = index + 1;
          const msg = `رقمك الحالي في القائمة: ${position} من ${actives.length}`;
          document.getElementById('queueHint').style.display = 'block';
          document.getElementById('queueHint').textContent = msg;
        } else {
          document.getElementById('queueHint').style.display = 'none';
        }
      } catch (e) {
        console.warn('queue calc error', e);
      }
    }

    /* ====== الحجز والدفع ====== */
    async function onConfirmBooking() {
      const form = document.getElementById('bookingForm');
      if (!form.checkValidity()) { form.reportValidity(); return; }
      if (!document.getElementById('lat').value || !document.getElementById('lng').value) { alert('فضلاً حدّد موقع السيارة من الخريطة.'); return; }
      if (!document.getElementById('package').value) { alert('فضلاً اختر نوع الغسيل.'); return; }
      if (!document.getElementById('carType').value) { alert('فضلاً اختر نوع السيارة.'); return; }

      const now = Date.now();
      const booking = {
        phone: document.getElementById('phone').value.trim(),
        package: document.getElementById('package').value,
        carType: document.getElementById('carType').value,
        carNumber: document.getElementById('carNumber').value.trim(),
        carCode: document.getElementById('carCode').value.trim().toUpperCase(),
        address: document.getElementById('address').value.trim(),
        lat: document.getElementById('lat').value || null,
        lng: document.getElementById('lng').value || null,
        price: parseFloat(document.getElementById('priceValue').innerText) || 0,
        status: 'pending',
        createdAt: new Date(now).toISOString(),
        createdAtMs: now
      };

      try {
        // حفظ الحجز أولاً
        const docRef = await db.collection('bookings').add(booking);
        currentBookingId = docRef.id;

        // حساب رقم الدور من القائمة النشطة (يشمل طلبك) بدون فلترة في الاستعلام
        const snap = await db.collection('bookings')
          .orderBy('createdAtMs')
          .get();
        const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        const actives = docs.filter(b => ACTIVE_STATUSES.includes(b.status));
        const index = actives.findIndex(d => d.id === currentBookingId);
        const position = (index >= 0) ? index + 1 : actives.length;

        const msg = `تم استلام طلبك ✅. رقمك في التسلسل: ${position}`;
        alert(msg);
        showBanner(msg);
        document.getElementById('queueHint').style.display = 'block';
        document.getElementById('queueHint').textContent = `رقمك الحالي في القائمة: ${position} من ${actives.length}`;

        // متابعة حالة الحجز وتحديث رقم الدور تلقائياً
        subscribeToBooking(currentBookingId);

        // إظهار قسم الدفع
        document.getElementById('paymentSection').style.display = 'block';
        document.getElementById('paymentSection').scrollIntoView({ behavior: 'smooth' });
      } catch (err) {
        console.error('Save error:', err);
        alert('حصل خطأ أثناء حفظ الحجز.\n' + (err && err.message ? err.message : ''));
      }
    }

    async function onCompletePayment() {
      try {
        if (!currentBookingId) { alert('لا يوجد حجز قيد التأكيد.'); return; }

        await db.collection('bookings').doc(currentBookingId).update({
          status: 'confirmed',
          paidAt: new Date().toISOString()
        });

        const btn = document.getElementById('paymentButton');
        btn.textContent = 'تم الدفع ✅';
        btn.classList.remove('primary');
        btn.classList.add('success');
        btn.disabled = true;

        alert('تم الدفع وتأكيد الحجز بنجاح ✅');
        document.getElementById('paymentSection').style.display = 'block';

        // تحديث رقم الدور بعد تغيّر الحالة
        await updateQueuePositionBanner(currentBookingId);
      } catch (err) {
        console.error('Confirm error:', err);
        alert('حصل خطأ أثناء تأكيد الدفع.\n' + (err && err.message ? err.message : ''));
      }
    }

    /* ====== لوحة الموظف ====== */
    let unsubscribeActiveList = null;
    function subscribeActiveList() {
      if (unsubscribeActiveList) unsubscribeActiveList();
      // الاستماع المباشر لجميع الطلبات وترشيح النشطة محلياً
      unsubscribeActiveList = db.collection('bookings')
        .orderBy('createdAtMs')
        .onSnapshot(snap => {
          const docs = [];
          snap.forEach(doc => docs.push({id: doc.id, ...doc.data()}));
          const actives = docs.filter(b => ACTIVE_STATUSES.includes(b.status));
          document.getElementById('activeCount').textContent = `القائمة النشطة: ${actives.length}`;

          const list = document.getElementById('activeList');
          list.innerHTML = '';
          actives.forEach((b, i) => {
            const el = document.createElement('div');
            el.className = 'item';
            el.innerHTML = `
              <div style="min-width:0">
                <div style="font-weight:800">#${i+1} — ${b.carCode || ''} ${b.carNumber || ''} • ${b.carType || ''}</div>
                <div class="muted" style="font-size:.95rem">${b.package === 'both' ? 'خارجي وداخلي' : 'خارجي فقط'} • ${b.phone} • ${new Date(b.createdAt).toLocaleString('ar')}</div>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn light" onclick="staffAccept('${b.id}')">بدء / قبول</button>
                <button class="btn success" onclick="staffComplete('${b.id}')">تم التنفيذ</button>
                <button class="btn" onclick="staffReject('${b.id}')">رفض المهمة</button>
              </div>
            `;
            list.appendChild(el);
          });
        }, err => {
          console.error('active list error', err);
        });
    }

    async function staffAccept(id) {
      try {
        await db.collection('bookings').doc(id).update({ status: 'accepted', acceptedAt: new Date().toISOString() });
      } catch (e) { console.error(e); alert('تعذر تحديث الحالة.\n' + (e && e.message ? e.message : '')); }
    }
    async function staffComplete(id) {
      try {
        await db.collection('bookings').doc(id).update({ status: 'completed', completedAt: new Date().toISOString() });
      } catch (e) { console.error(e); alert('تعذر تحديث الحالة.\n' + (e && e.message ? e.message : '')); }
    }
    async function staffReject(id) {
      try {
        await db.collection('bookings').doc(id).update({ status: 'rejected', rejectedAt: new Date().toISOString() });
      } catch (e) { console.error(e); alert('تعذر تحديث الحالة.\n' + (e && e.message ? e.message : '')); }
    }
  </script>

<!-- ================== ساعات العمل — الواجهة العامة + الحارس ================== -->
<style>
  .vh-hours-btn{position:fixed;z-index:9999;bottom:18px;right:18px;background:#1f6fff;color:#fff;border:none;
    border-radius:999px;display:flex;align-items:center;gap:10px;padding:12px 14px;box-shadow:0 10px 30px rgba(31,111,255,.35);cursor:pointer;font-family:'Tajawal',sans-serif}
  .vh-hours-btn svg{width:20px;height:20px}
  .vh-modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.45);backdrop-filter:blur(2px);display:none;z-index:9998}
  .vh-modal{position:fixed;inset:0;display:none;place-items:center;z-index:9999}
  .vh-card{width:min(720px,95vw);max-height:86vh;overflow:auto;background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(2,6,23,.25);padding:16px;direction:rtl}
  .vh-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .vh-hdr h3{font:700 18px 'Tajawal',system-ui;margin:0}
  .vh-close{background:transparent;border:none;font-size:22px;cursor:pointer}
  .vh-list{display:grid;grid-template-columns:1fr;gap:8px}
  .vh-item{display:flex;align-items:center;justify-content:space-between;border:1px solid #eef2f7;border-radius:12px;padding:10px}
  .vh-badge{background:#eff6ff;color:#1e3a8a;border-radius:999px;padding:3px 10px;font:700 12px 'Tajawal'}
  .vh-muted{color:#64748b;font:600 13px 'Tajawal'}
  .vh-open{color:#16a34a;font-weight:700}
  .vh-closed{color:#ef4444;font-weight:700}
</style>

<button type="button" class="vh-hours-btn" id="vhOpenBtn" title="عرض أوقات العمل">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="9"/></svg>
  <span>ساعات العمل</span>
</button>

<div class="vh-modal-backdrop" id="vhBackdrop"></div>
<div class="vh-modal" id="vhModal" role="dialog" aria-modal="true" aria-labelledby="vhTitle">
  <div class="vh-card">
    <div class="vh-hdr">
      <h3 id="vhTitle">ساعات العمل</h3>
      <button class="vh-close" id="vhCloseBtn" aria-label="إغلاق">×</button>
    </div>
    <div id="vhList" class="vh-list"></div>
    <div style="margin-top:10px" class="vh-muted">يمكنك تعديل الساعات من صفحة الأدمن.</div>
  </div>
</div>

<script>
(function(){
  const STORAGE_KEY = "businessHoursV1";
  const DAYS_AR = ["السبت","الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة"];
  const mapJsToOur = {6:0, 0:1, 1:2, 2:3, 3:4, 4:5, 5:6};

  function loadHours(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      const parsed = JSON.parse(raw);
      if(!Array.isArray(parsed) || parsed.length!==7) return null;
      return parsed;
    }catch(e){ return null; }
  }

  function renderList(listEl, hours){
    if(!hours){
      listEl.innerHTML = `<div class="vh-item"><span class="vh-muted">لم يتم ضبط ساعات العمل بعد.</span><span class="vh-badge">الرجاء التعيين من الأدمن</span></div>`;
      return;
    }
    const rows = hours.map((h, i)=>{
      if(h.closed){
        return `<div class="vh-item"><b>${DAYS_AR[i]}</b><span class="vh-closed">مغلق</span></div>`;
      }
      const p1 = h.p1 && h.p1.from && h.p1.to ? `${h.p1.from}–${h.p1.to}` : "—";
      const p2 = h.p2 && h.p2.enabled && h.p2.from && h.p2.to ? `، ${h.p2.from}–${h.p2.to}` : "";
      return `<div class="vh-item"><b>${DAYS_AR[i]}</b><span class="vh-open">${p1}${p2}</span></div>`;
    }).join("");
    listEl.innerHTML = rows;
  }

  function toMinutes(t){ if(!t) return null; const parts=t.split(":"); return (+parts[0])*60 + (+parts[1]); }
  function isInRange(mins, from, to){ const f=toMinutes(from), tt=toMinutes(to); return f!=null && tt!=null && mins>=f && mins<=tt; }

  function isOpenAt(date, hours){
    if(!hours) return true; // if not configured, don't block
    const jsDay = date.getDay();
    const idx = mapJsToOur[jsDay];
    const h = hours[idx];
    if(!h || h.closed) return false;
    const curMins = date.getHours()*60 + date.getMinutes();
    if(h.p1 && h.p1.from && h.p1.to && isInRange(curMins, h.p1.from, h.p1.to)) return true;
    if(h.p2 && h.p2.enabled && h.p2.from && h.p2.to && isInRange(curMins, h.p2.from, h.p2.to)) return true;
    return false;
  }

  function nextOpenDate(fromDate, hours){
    if(!hours) return null;
    const d = new Date(fromDate.getTime());
    for(let i=0;i<14;i++){
      const jsDay = d.getDay();
      const idx = mapJsToOur[jsDay];
      const h = hours[idx];
      if(h && !h.closed){
        const curMins = d.getHours()*60 + d.getMinutes();
        const p1f = toMinutes(h.p1 && h.p1.from);
        const p1t = toMinutes(h.p1 && h.p1.to);
        const p2f = toMinutes(h.p2 && h.p2.from);
        const p2t = toMinutes(h.p2 && h.p2.to);

        if(i===0){
          // if currently within any period => now
          if((h.p1 && h.p1.from && h.p1.to && isInRange(curMins, h.p1.from, h.p1.to)) ||
             (h.p2 && h.p2.enabled && h.p2.from && h.p2.to && isInRange(curMins, h.p2.from, h.p2.to))){
            return new Date(d.getTime());
          }
          // next start today
          if(p1f!=null && curMins < p1f){
            const nd = new Date(d.getTime()); nd.setHours(Math.floor(p1f/60), p1f%60,0,0); return nd;
          }
          if(h.p2 && h.p2.enabled && p2f!=null && curMins < p2f){
            const nd = new Date(d.getTime()); nd.setHours(Math.floor(p2f/60), p2f%60,0,0); return nd;
          }
        } else {
          // future days: pick earliest available start
          if(p1f!=null){
            const nd = new Date(d.getTime()); nd.setHours(Math.floor(p1f/60), p1f%60,0,0); return nd;
          }
          if(h.p2 && h.p2.enabled && p2f!=null){
            const nd = new Date(d.getTime()); nd.setHours(Math.floor(p2f/60), p2f%60,0,0); return nd;
          }
        }
      }
      // move to next day 00:00
      d.setDate(d.getDate()+1);
      d.setHours(0,0,0,0);
    }
    return null;
  }

  function formatDateAr(dt){
    const days = ["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"];
    const d = days[dt.getDay()];
    const hh = String(dt.getHours()).padStart(2,"0");
    const mm = String(dt.getMinutes()).padStart(2,"0");
    return `${d} ${hh}:${mm}`;
  }

  // attach viewer
  const vhOpenBtn = document.getElementById("vhOpenBtn");
  const vhBackdrop = document.getElementById("vhBackdrop");
  const vhModal = document.getElementById("vhModal");
  const vhCloseBtn = document.getElementById("vhCloseBtn");
  const vhList = document.getElementById("vhList");

  function openViewer(){
    renderList(vhList, loadHours());
    vhBackdrop.style.display = "block";
    vhModal.style.display = "grid";
  }
  function closeViewer(){
    vhBackdrop.style.display = "none";
    vhModal.style.display = "none";
  }

  vhOpenBtn.addEventListener("click", openViewer);
  vhCloseBtn.addEventListener("click", closeViewer);
  vhBackdrop.addEventListener("click", closeViewer);

  // --------- Guards on forms (optional auto hook) ---------
  function resolveSelectedDate(form){
    // try datetime-local
    let dtInput = form.querySelector("input[type='datetime-local']");
    if(dtInput && dtInput.value){
      return new Date(dtInput.value);
    }
    // try date + time
    let dateInput = form.querySelector("input[type='date']");
    let timeInput = form.querySelector("input[type='time']");
    if(dateInput && dateInput.value && timeInput && timeInput.value){
      return new Date(`${dateInput.value}T${timeInput.value}`);
    }
    // try time only (use today)
    if(timeInput && timeInput.value){
      const today = new Date();
      const [h,m] = timeInput.value.split(":").map(Number);
      today.setHours(h||0, m||0, 0, 0);
      return today;
    }
    // fallback now
    return new Date();
  }

  function attachGuardToForm(form){
    if(form.__bh_guard_attached) return;
    form.__bh_guard_attached = true;
    form.addEventListener("submit", (ev)=>{
      const hours = loadHours();
      const selDate = resolveSelectedDate(form);
      if(!isOpenAt(selDate, hours)){
        ev.preventDefault();
        const next = nextOpenDate(selDate, hours);
        const msg = next ? `خارج أوقات العمل الآن.\nنبدأ العمل في: ${formatDateAr(next)}.` 
                         : "خارج أوقات العمل الآن.";
        alert(msg);
      }
    }, true);
  }

  function autoAttach(){
    const forms = Array.from(document.querySelectorAll("form#bookingForm, form[data-check-hours='true']"));
    forms.forEach(attachGuardToForm);
  }
  autoAttach();
  // also watch DOM changes for dynamically added forms
  const mo = new MutationObserver(autoAttach);
  mo.observe(document.documentElement, {childList:true, subtree:true});

  // expose helpers globally if needed
  window.businessHours = {
    load: loadHours,
    isOpenAt: (date)=>isOpenAt(date, loadHours()),
    nextOpen: (date)=>nextOpenDate(date, loadHours())
  };
})();
</script>

<!-- ===== Patch: Instant banner + broader guard hooks ===== -->
<style>
  .vh-banner{position:fixed;top:14px;right:14px;z-index:99999;background:#fff;border:1px solid #e5e7eb;
    box-shadow:0 8px 30px rgba(2,6,23,.15);border-radius:12px;padding:10px 12px;display:none;direction:rtl}
  .vh-banner .t{font:700 14px 'Tajawal',system-ui;margin:0 0 4px 0;color:#0f172a}
  .vh-banner .s{font:600 13px 'Tajawal',system-ui;margin:0;color:#475569}
</style>
<div class="vh-banner" id="vhBanner">
  <div class="t">الآن خارج أوقات العمل</div>
  <div class="s" id="vhBannerMsg">ستستأنف الخدمة قريبًا…</div>
</div>

<script>
(function(){
  // Reuse helpers from previous block (loadHours, isOpenAt, nextOpenDate, formatDateAr) if present:
  const hasHelpers = window.businessHours && typeof window.businessHours.load === 'function';
  const STORAGE_KEY = "businessHoursV1";
  const mapJsToOur = {6:0, 0:1, 1:2, 2:3, 3:4, 4:5, 5:6};

  function loadHours(){
    if(hasHelpers) return window.businessHours.load();
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      const parsed = JSON.parse(raw);
      if(!Array.isArray(parsed) || parsed.length!==7) return null;
      return parsed;
    }catch(e){ return null; }
  }
  function toMinutes(t){ if(!t) return null; const parts=t.split(":"); return (+parts[0])*60 + (+parts[1]); }
  function isInRange(mins, from, to){ const f=toMinutes(from), tt=toMinutes(to); return f!=null && tt!=null && mins>=f && mins<=tt; }
  function isOpenAt(date, hours){
    if(!hours) return true;
    const jsDay = date.getDay();
    const idx = mapJsToOur[jsDay];
    const h = hours[idx];
    if(!h || h.closed) return false;
    const curMins = date.getHours()*60 + date.getMinutes();
    if(h.p1 && h.p1.from && h.p1.to && isInRange(curMins, h.p1.from, h.p1.to)) return true;
    if(h.p2 && h.p2.enabled && h.p2.from && h.p2.to && isInRange(curMins, h.p2.from, h.p2.to)) return true;
    return false;
  }
  function nextOpenDate(fromDate, hours){
    if(!hours) return null;
    const d = new Date(fromDate.getTime());
    for(let i=0;i<14;i++){
      const jsDay = d.getDay();
      const idx = mapJsToOur[jsDay];
      const h = hours[idx];
      if(h && !h.closed){
        const curMins = d.getHours()*60 + d.getMinutes();
        const p1f = toMinutes(h.p1 && h.p1.from);
        const p2f = toMinutes(h.p2 && h.p2.from);
        // same day, look for next future start
        if(i===0){
          if(p1f!=null && curMins < p1f){
            const nd = new Date(d.getTime()); nd.setHours(Math.floor(p1f/60), p1f%60,0,0); return nd;
          }
          if(h.p2 && h.p2.enabled && p2f!=null && curMins < p2f){
            const nd = new Date(d.getTime()); nd.setHours(Math.floor(p2f/60), p2f%60,0,0); return nd;
          }
        } else {
          // future day earliest start
          if(p1f!=null){ const nd = new Date(d.getTime()); nd.setHours(Math.floor(p1f/60), p1f%60,0,0); return nd; }
          if(h.p2 && h.p2.enabled && p2f!=null){ const nd = new Date(d.getTime()); nd.setHours(Math.floor(p2f/60), p2f%60,0,0); return nd; }
        }
      }
      d.setDate(d.getDate()+1); d.setHours(0,0,0,0);
    }
    return null;
  }
  function formatDateAr(dt){
    const days = ["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"];
    const d = days[dt.getDay()];
    const hh = String(dt.getHours()).padStart(2,"0");
    const mm = String(dt.getMinutes()).padStart(2,"0");
    return `${d} ${hh}:${mm}`;
  }

  // Banner handling
  const vhBanner = document.getElementById("vhBanner");
  const vhBannerMsg = document.getElementById("vhBannerMsg");
  function updateBanner(){
    const hours = loadHours();
    const now = new Date();
    if(!isOpenAt(now, hours)){
      const next = nextOpenDate(now, hours);
      vhBanner.style.display = "block";
      vhBannerMsg.textContent = next ? `ستُستأنف الخدمة في: ${formatDateAr(next)}` : "خارج أوقات العمل.";
    }else{
      vhBanner.style.display = "none";
    }
  }
  updateBanner();
  setInterval(updateBanner, 60000);
  window.addEventListener("business-hours-updated", updateBanner);

  // Stronger guard: attach to any form or button/link marked with data-check-hours
  function resolveSelectedDateFrom(el){
    // Optional selector override: data-time-selector points to an input with a time/date
    const sel = el.getAttribute && el.getAttribute("data-time-selector");
    if(sel){
      const t = document.querySelector(sel);
      if(t && t.value){
        // try to build a Date
        if(t.type==="datetime-local"){ return new Date(t.value); }
        if(t.type==="time"){
          const d=new Date(); const [h,m]=t.value.split(":").map(Number); d.setHours(h||0,m||0,0,0); return d;
        }
        if(t.type==="date"){
          return new Date(t.value+"T00:00");
        }
      }
    }
    // search upwards: if inside a form, reuse previous heuristic
    const form = el.closest ? el.closest("form") : null;
    if(form){
      const dtl = form.querySelector("input[type='datetime-local']");
      if(dtl && dtl.value) return new Date(dtl.value);
      const dateI = form.querySelector("input[type='date']");
      const timeI = form.querySelector("input[type='time']");
      if(dateI && dateI.value && timeI && timeI.value) return new Date(`${dateI.value}T${timeI.value}`);
      if(timeI && timeI.value){
        const d=new Date(); const [h,m]=timeI.value.split(":").map(Number); d.setHours(h||0,m||0,0,0); return d;
      }
    }
    return new Date();
  }

  function blockIfClosed(ev, el){
    const hours = loadHours();
    const dt = resolveSelectedDateFrom(el);
    if(!isOpenAt(dt, hours)){
      ev.preventDefault();
      const next = nextOpenDate(dt, hours);
      alert(next ? `هذا الوقت خارج أوقات العمل.
ستُستأنف الخدمة في: ${formatDateAr(next)}.`
                 : "هذا الوقت خارج أوقات العمل.");
      updateBanner();
      return true;
    }
    return false;
  }

  function attachGuards(){
    // Forms
    document.querySelectorAll("form#bookingForm, form[data-check-hours], form.check-hours").forEach(form=>{
      if(form.__bh_guard_attached) return;
      form.__bh_guard_attached = true;
      form.addEventListener("submit", (ev)=>{
        if(blockIfClosed(ev, form)){ /* blocked */ }
      }, true);
    });
    // Triggers (buttons/links)
    document.querySelectorAll("[data-check-hours-trigger]").forEach(el=>{
      if(el.__bh_guard_attached) return;
      el.__bh_guard_attached = true;
      el.addEventListener("click", (ev)=>{
        if(blockIfClosed(ev, el)) return;
        // optional: auto-submit a target form if specified
        const targetSel = el.getAttribute("data-submit-target");
        if(targetSel){
          const f = document.querySelector(targetSel);
          if(f) f.requestSubmit ? f.requestSubmit() : f.submit();
        }
      }, true);
    });
  }
  attachGuards();
  const mo = new MutationObserver(attachGuards);
  mo.observe(document.documentElement, {childList:true, subtree:true});

})();
</script>


<!-- ===== Mega Outside-Hours Notice (Large & Eye-Catching) ===== -->
<style>
  /* Hide the small banner from previous version */
  .vh-banner{ display: none !important; }

  .vh-mega-backdrop{
    position: fixed; inset: 0; background: rgba(2,6,23,.45); backdrop-filter: blur(2px);
    display: none; z-index: 100000;
  }
  .vh-mega{
    position: fixed; z-index: 100001; top: 24px; left: 50%; transform: translateX(-50%);
    width: min(960px, 96vw); display: none; direction: rtl;
    background: #ffffff;
    border-radius: 18px;
    padding: 18px 20px;
    box-shadow: 0 30px 90px rgba(2,6,23,.35), 0 0 0 4px rgba(239, 68, 68, .10) inset;
    border: 1px solid #f1f5f9;
    animation: vhSlideDown .4s ease, vhGlow 2.2s ease-in-out infinite;
  }
  @keyframes vhSlideDown{
    from { transform: translate(-50%, -12px); opacity: 0; }
    to   { transform: translate(-50%, 0); opacity: 1; }
  }
  @keyframes vhGlow{
    0%,100% { box-shadow: 0 30px 90px rgba(2,6,23,.35), 0 0 0 4px rgba(239, 68, 68, .10) inset; }
    50%     { box-shadow: 0 30px 90px rgba(2,6,23,.35), 0 0 0 6px rgba(239, 68, 68, .20) inset; }
  }
  .vh-mega-wrap{
    display: grid; grid-template-columns: 72px 1fr auto; gap: 16px; align-items: center;
  }
  .vh-mega-icon{
    width: 72px; height: 72px; border-radius: 16px;
    background: radial-gradient(120% 120% at 100% 0%, #fee2e2 0%, #fff1f2 45%, #ffffff 100%);
    display: grid; place-items: center;
    box-shadow: inset 0 0 0 2px #fecaca;
  }
  .vh-mega-icon svg{ width: 40px; height: 40px; color: #ef4444; }
  .vh-mega-title{
    font: 800 20px/1.2 'Tajawal', system-ui; color: #0f172a; margin-bottom: 6px;
  }
  .vh-mega-line{
    display: flex; flex-wrap: wrap; align-items: center; gap: 10px;
    font: 700 16px/1.6 'Tajawal', system-ui; color: #334155;
  }
  .vh-mega-count{
    font: 800 16px 'Tajawal', system-ui; color: #ef4444; background: #fff1f2; border-radius: 999px;
    padding: 4px 10px; border: 1px solid #ffe4e6;
  }
  .vh-mega-progress{
    height: 8px; background: #f1f5f9; border-radius: 999px; overflow: hidden; margin-top: 10px;
  }
  .vh-mega-progress > span{
    display:block; width: 100%; height: 100%;
    background: repeating-linear-gradient(90deg, #fecaca 0 16px, #fee2e2 16px 32px);
    animation: vhProgress 1.3s linear infinite;
  }
  @keyframes vhProgress{
    from { transform: translateX(0); }
    to   { transform: translateX(-32px); }
  }
  .vh-mega-close{
    background: #0f172a; color: #fff; border: none; border-radius: 10px; cursor: pointer;
    padding: 10px 12px; font: 800 14px 'Tajawal', system-ui;
  }
  .vh-mega-sub{ font: 600 13px 'Tajawal', system-ui; color: #475569; }
  @media (max-width: 600px){
    .vh-mega-wrap{ grid-template-columns: 56px 1fr auto; }
    .vh-mega-icon{ width:56px; height:56px; }
    .vh-mega-icon svg{ width:32px; height:32px; }
    .vh-mega-title{ font-size: 18px; }
    .vh-mega-line{ font-size: 15px; }
    .vh-mega-count{ font-size: 15px; }
  }
</style>

<div class="vh-mega-backdrop" id="vhMegaBackdrop"></div>
<div class="vh-mega" id="vhMega" role="alert" aria-live="assertive">
  <div class="vh-mega-wrap">
    <div class="vh-mega-icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="12" cy="12" r="9" stroke-width="2"/>
        <path d="M12 7v5l3 3" stroke-width="2" />
      </svg>
    </div>
    <div>
      <div class="vh-mega-title">الآن خارج أوقات العمل</div>
      <div class="vh-mega-line">
        <span id="vhMegaMsg">ستُستأنف الخدمة قريبًا…</span>
        <span class="vh-mega-count" id="vhMegaCount">—:—:—</span>
      </div>
      <div class="vh-mega-progress" aria-hidden="true"><span></span></div>
      <div class="vh-mega-sub" id="vhMegaSub"></div>
    </div>
    <button class="vh-mega-close" id="vhMegaClose" aria-label="إغلاق">إغلاق</button>
  </div>
</div>

<script>
(function(){
  const STORAGE_KEY = "businessHoursV1";
  const mapJsToOur = {6:0, 0:1, 1:2, 2:3, 3:4, 4:5, 5:6};

  function loadHours(){
    try{
      if(window.businessHours && window.businessHours.load) return window.businessHours.load();
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      const parsed = JSON.parse(raw);
      return (Array.isArray(parsed) && parsed.length===7) ? parsed : null;
    }catch(e){ return null; }
  }
  function toMinutes(t){ if(!t) return null; const [H,M] = t.split(":").map(Number); return H*60+M; }
  function isInRange(mins, from, to){ const f=toMinutes(from), tt=toMinutes(to); return f!=null && tt!=null && mins>=f && mins<=tt; }

  function isOpenAt(date, hours){
    if(!hours) return true;
    const idx = mapJsToOur[date.getDay()];
    const h = hours[idx];
    if(!h || h.closed) return false;
    const curMins = date.getHours()*60 + date.getMinutes();
    if(h.p1 && h.p1.from && h.p1.to && isInRange(curMins, h.p1.from, h.p1.to)) return true;
    if(h.p2 && h.p2.enabled && h.p2.from && h.p2.to && isInRange(curMins, h.p2.from, h.p2.to)) return true;
    return false;
  }

  function nextOpenDate(fromDate, hours){
    if(!hours) return null;
    const d = new Date(fromDate.getTime());
    for(let i=0;i<14;i++){
      const idx = mapJsToOur[d.getDay()];
      const h = hours[idx];
      if(h && !h.closed){
        const curMins = d.getHours()*60 + d.getMinutes();
        const p1f = toMinutes(h.p1 && h.p1.from), p2f = toMinutes(h.p2 && h.p2.from);
        if(i===0){
          if(p1f!=null && curMins < p1f){ const nd=new Date(d); nd.setHours(Math.floor(p1f/60), p1f%60,0,0); return nd; }
          if(h.p2 && h.p2.enabled && p2f!=null && curMins < p2f){ const nd=new Date(d); nd.setHours(Math.floor(p2f/60), p2f%60,0,0); return nd; }
        }else{
          if(p1f!=null){ const nd=new Date(d); nd.setHours(Math.floor(p1f/60), p1f%60,0,0); return nd; }
          if(h.p2 && h.p2.enabled && p2f!=null){ const nd=new Date(d); nd.setHours(Math.floor(p2f/60), p2f%60,0,0); return nd; }
        }
      }
      d.setDate(d.getDate()+1); d.setHours(0,0,0,0);
    }
    return null;
  }

  function fmtAbs(dt){
    const days = ["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"];
    const dd = days[dt.getDay()];
    const hh = String(dt.getHours()).padStart(2,"0");
    const mm = String(dt.getMinutes()).padStart(2,"0");
    return `${dd} ${hh}:${mm}`;
  }
  function fmtDelta(ms){
    if(ms<=0) return "00:00:00";
    let s = Math.floor(ms/1000);
    const h = Math.floor(s/3600); s -= h*3600;
    const m = Math.floor(s/60); s -= m*60;
    const pad = n=>String(n).padStart(2,"0");
    return `${pad(h)}:${pad(m)}:${pad(s)}`;
  }

  const mega = document.getElementById("vhMega");
  const backdrop = document.getElementById("vhMegaBackdrop");
  const msg = document.getElementById("vhMegaMsg");
  const count = document.getElementById("vhMegaCount");
  const sub = document.getElementById("vhMegaSub");
  const btnClose = document.getElementById("vhMegaClose");

  let dismissed = false;
  btnClose.addEventListener("click", ()=>{ dismissed = true; mega.style.display = "none"; backdrop.style.display="none"; });

  function updateMega(){
    const hours = loadHours();
    const now = new Date();
    if(isOpenAt(now, hours)){ dismissed=false; mega.style.display="none"; backdrop.style.display="none"; return; }
    const next = nextOpenDate(now, hours);
    if(dismissed) return;
    msg.textContent = next ? `ستُستأنف الخدمة في: ${fmtAbs(next)}` : "خارج أوقات العمل.";
    if(next){
      const diff = next.getTime()-now.getTime();
      count.textContent = fmtDelta(diff);
      sub.textContent = "لن يمكنك إكمال الحجز الآن. الرجاء المحاولة عند بدء الدوام.";
    }else{
      count.textContent = "—:—:—";
      sub.textContent = "لن يمكنك إكمال الحجز الآن.";
    }
    mega.style.display = "block";
    backdrop.style.display = "block";
  }

  updateMega();
  setInterval(updateMega, 1000);
  window.addEventListener("business-hours-updated", updateMega);
})();
</script>


<!-- ===== Cloud Business Hours (Firestore) Sync for Frontend ===== -->
<script>
(function(){
  const STORAGE_KEY = "businessHoursV1";
  if (!(window.firebase && window.firebase.firestore && window.db)) {
    console.warn("[hours] Firebase not found; cloud sync disabled.");
    return;
  }
  const HOURS_DOC = db.collection('config').doc('businessHours');

  async function seedFromCloud(){
    try{
      const snap = await HOURS_DOC.get();
      if(snap.exists && snap.data() && Array.isArray(snap.data().hours) && snap.data().hours.length===7){
        localStorage.setItem(STORAGE_KEY, JSON.stringify(snap.data().hours));
        window.dispatchEvent(new CustomEvent("business-hours-updated", { detail: snap.data().hours }));
      }
    }catch(e){ console.warn("[hours] seed error:", e); }
  }
  function subscribeLive(){
    try{
      return HOURS_DOC.onSnapshot(snap=>{
        const d = snap.data && snap.data();
        if(snap.exists && d && Array.isArray(d.hours) && d.hours.length===7){
          localStorage.setItem(STORAGE_KEY, JSON.stringify(d.hours));
          window.dispatchEvent(new CustomEvent("business-hours-updated", { detail: d.hours }));
        }
      });
    }catch(e){ console.warn("[hours] live sub failed:", e); return null; }
  }
  seedFromCloud();
  subscribeLive();
})();
</script>

</body>
</html>
