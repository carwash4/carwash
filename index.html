<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>واجهة الحجز — أوقات العمل</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#f7fbff; --fg:#0f172a; --muted:#64748b; --card:#fff; --border:#e5e7eb; --accent:#1f6fff; --danger:#ef4444; }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:linear-gradient(180deg,#f3f7ff 0%,#eef4ff 100%);font-family:'Tajawal',system-ui}
    .wrap{max-width:900px;margin:28px auto;padding:0 14px}
    .title{font:800 24px 'Tajawal';color:var(--fg)}
    .panel{margin-top:16px;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 16px 60px rgba(2,6,23,.06)}
    .field{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    .btn{border:none;border-radius:12px;background:var(--accent);color:#fff;font:800 14px 'Tajawal';padding:10px 14px;cursor:pointer}
    .vh-mega-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.45);backdrop-filter:blur(2px);display:none;z-index:10000}
    .vh-mega{position:fixed;z-index:10001;top:24px;left:50%;transform:translateX(-50%);width:min(960px,96vw);background:#fff;border-radius:18px;padding:18px 20px;border:1px solid #f1f5f9;box-shadow:0 30px 90px rgba(2,6,23,.35)}
    .vh-mega .title{display:flex;gap:8px;align-items:center}
    .vh-mega .title .dot{width:10px;height:10px;border-radius:50%;background:#ef4444}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">واجهة الحجز</div>
    <div class="panel">
      <form id="bookingForm" data-check-hours>
        <div class="field">
          <label>التاريخ:</label>
          <input type="date" id="dateI" required />
          <label>الوقت:</label>
          <input type="time" id="timeI" required />
        </div>
        <button class="btn" type="submit">احجز الآن</button>
      </form>
      <div class="muted" style="color:#64748b;margin-top:8px">هذه صفحة اختبار — اربط نفس الوسوم في مشروعك.</div>
    </div>
  </div>

  <div class="vh-mega-backdrop hidden" id="vhMegaBackdrop"></div>
  <div class="vh-mega hidden" id="vhMega" role="alert" aria-live="assertive">
    <div class="title"><span class="dot"></span><b>الآن خارج أوقات العمل</b></div>
    <div id="vhMegaMsg" style="margin-top:8px;font-weight:700;color:#334155"></div>
  </div>

  <!-- Firebase SDK v8 compat -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
  if (!firebase.apps.length) {
    var firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
  }
  window.db = firebase.firestore();
  </script>

  <script>
  const STORAGE_KEY = "businessHoursV1";
  const mapJsToOur = {6:0, 0:1, 1:2, 2:3, 3:4, 4:5, 5:6};

  function toMinutes(t){ if(!t) return null; const [H,M] = t.split(":").map(Number); return H*60+M; }
  function isInRange(mins, from, to){ const f=toMinutes(from), tt=toMinutes(to); return f!=null && tt!=null && mins>=f && mins<=tt; }
  function isOpenAt(date, hours){
    if(!hours) return true;
    const idx = mapJsToOur[date.getDay()];
    const h = hours[idx];
    if(!h || h.closed) return false;
    const curMins = date.getHours()*60 + date.getMinutes();
    if(h.p1 && h.p1.from && h.p1.to && isInRange(curMins, h.p1.from, h.p1.to)) return true;
    if(h.p2 && h.p2.enabled && h.p2.from && h.p2.to && isInRange(curMins, h.p2.from, h.p2.to)) return true;
    return false;
  }
  function nextOpenDate(fromDate, hours){
    if(!hours) return null;
    const d = new Date(fromDate.getTime());
    for(let i=0;i<14;i++){
      const idx = mapJsToOur[d.getDay()];
      const h = hours[idx];
      if(h && !h.closed){
        const curMins = d.getHours()*60 + d.getMinutes();
        const p1f = toMinutes(h.p1 && h.p1.from), p2f = toMinutes(h.p2 && h.p2.from);
        if(i===0){
          if(p1f!=null && curMins < p1f){ const nd=new Date(d); nd.setHours(Math.floor(p1f/60), p1f%60,0,0); return nd; }
          if(h.p2 && h.p2.enabled && p2f!=null && curMins < p2f){ const nd=new Date(d); nd.setHours(Math.floor(p2f/60), p2f%60,0,0); return nd; }
        }else{
          if(p1f!=null){ const nd=new Date(d); nd.setHours(Math.floor(p1f/60), p1f%60,0,0); return nd; }
          if(h.p2 && h.p2.enabled && p2f!=null){ const nd=new Date(d); nd.setHours(Math.floor(p2f/60), p2f%60,0,0); return nd; }
        }
      }
      d.setDate(d.getDate()+1); d.setHours(0,0,0,0);
    }
    return null;
  }
  function formatAbs(dt){
    const days = ["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"];
    return `${days[dt.getDay()]} ${String(dt.getHours()).padStart(2,"0")}:${String(dt.getMinutes()).padStart(2,"0")}`;
  }

  const mega = document.getElementById('vhMega');
  const backdrop = document.getElementById('vhMegaBackdrop');
  const megaMsg = document.getElementById('vhMegaMsg');
  function showMega(msg){ megaMsg.textContent = msg; mega.classList.remove('hidden'); backdrop.classList.remove('hidden'); }
  function hideMega(){ mega.classList.add('hidden'); backdrop.classList.add('hidden'); }

  (function(){
    const HOURS_DOC = db.collection('config').doc('businessHours');
    try{ if(!sessionStorage.getItem("bhCloudSeeded")){ localStorage.removeItem(STORAGE_KEY); } }catch(_){}

    async function seed(){
      try{
        const snap = await HOURS_DOC.get();
        const d = snap.exists && snap.data();
        if(d && Array.isArray(d.hours) && d.hours.length===7){
          localStorage.setItem(STORAGE_KEY, JSON.stringify(d.hours));
          sessionStorage.setItem("bhCloudSeeded","1");
          window.dispatchEvent(new CustomEvent("business-hours-updated", { detail: d.hours }));
          updateBanner();
        }
      }catch(e){ console.warn("[index] seed error:", e); }
    }
    HOURS_DOC.onSnapshot(snap=>{
      const d = snap.data && snap.data();
      if(snap.exists && d && Array.isArray(d.hours)){
        localStorage.setItem(STORAGE_KEY, JSON.stringify(d.hours));
        sessionStorage.setItem("bhCloudSeeded","1");
        window.dispatchEvent(new CustomEvent("business-hours-updated", { detail: d.hours }));
        updateBanner();
      }
    });
    seed();
  })();

  function loadHours(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      const parsed = raw ? JSON.parse(raw) : null;
      return (Array.isArray(parsed) && parsed.length===7) ? parsed : null;
    }catch(_){ return null; }
  }

  function updateBanner(){
    const hours = loadHours();
    const now = new Date();
    if(!isOpenAt(now,hours)){
      const next = nextOpenDate(now, hours);
      showMega(next ? `ستُستأنف الخدمة في: ${formatAbs(next)}` : "خارج أوقات العمل.");
    }else{
      hideMega();
    }
  }
  setInterval(updateBanner, 60000);

  (function(){
    function resolveSelectedDate(){
      const d = document.getElementById('dateI').value;
      const t = document.getElementById('timeI').value;
      if(d && t) return new Date(`${d}T${t}`);
      const now = new Date(); return now;
    }
    function onSubmit(e){
      const hours = loadHours();
      const dt = resolveSelectedDate();
      if(!isOpenAt(dt, hours)){
        e.preventDefault();
        const next = nextOpenDate(dt, hours);
        showMega(next ? `هذا الوقت خارج أوقات العمل. ستُستأنف الخدمة في: ${formatAbs(next)}` : "خارج أوقات العمل.");
      }
    }
    document.getElementById('bookingForm').addEventListener('submit', onSubmit, true);
  })();
  </script>
</body>
</html>