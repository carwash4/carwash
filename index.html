<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„Ù…Ø¹Ø© â€” ØºØ³ÙŠÙ„ Ø³ÙŠØ§Ø±Ø§Øª Ù…ØªÙ†Ù‚Ù„</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

  <style>
    :root{
      --bg1:#e6f7ff; --bg2:#f0fffb; --ink:#0f1a2b;
      --brand:#00aaff; --brand2:#00d2a0;
      --muted:#5f7aa3; --card:#ffffff; --line:#e6eef8;
    }
    *{box-sizing:border-box}
    body { font-family:"Tajawal",sans-serif; background:radial-gradient(1200px 700px at 80% -10%,var(--bg1),transparent 60%),linear-gradient(180deg,var(--bg1),var(--bg2)); color:var(--ink); margin:0; }
    .hero { text-align:center; padding:28px 16px 18px; background:linear-gradient(135deg,rgba(0,170,255,.12),rgba(0,210,160,.10)),linear-gradient(180deg,#ffffffaa,#ffffff66); border-bottom:1px solid var(--line); }
    .hero h1{margin:8px 0 6px;font-size:2.2rem}
    .hero p{margin:0;color:var(--muted)}
    .formWrap{max-width:920px;margin:14px auto;background:var(--card);padding:20px;border-radius:14px;border:1px solid var(--line);box-shadow:0 10px 28px rgba(0,0,0,.06)}
    fieldset{border:1px dashed var(--line);border-radius:12px;padding:14px;margin-bottom:12px}
    legend{color:var(--muted)}
    input,select{width:100%;padding:12px;margin-bottom:10px;border-radius:10px;border:1px solid var(--line);background:#f8fbff;color:var(--ink);outline:none}
    input:focus,select:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(0,170,255,.15)}
    .row-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:640px){.row-2{grid-template-columns:1fr}}
    .price{font-size:1.25rem;font-weight:800;color:var(--brand)}
    .inline-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .btn{padding:12px 18px;border:none;border-radius:12px;cursor:pointer;font-weight:800}
    .btn.primary{background:var(--brand);color:#fff}
    .btn.success{background:var(--brand2);color:#003326}
    .btn.light{background:#eef6ff;color:#0f3c6e}
    #statusBanner{background:#e9fff6;border:1px solid #c3f5e5;color:#085a46}
    .map-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999}
    .map-card{width:min(94vw,840px);background:var(--card);border-radius:14px;padding:12px;box-shadow:0 16px 40px rgba(0,0,0,.18);border:1px solid var(--line)}
    #map{width:100%;height:440px;border-radius:12px}
    .map-actions{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;align-items:center}
    .hint{color:var(--muted)}
    footer{text-align:center;color:var(--muted);padding:10px 0 24px}
    .subhint{font-size:.9rem;color:var(--muted);margin-top:-6px}
    .badge{display:inline-block;background:#eef6ff;border:1px solid #d7e8ff;border-radius:999px;padding:6px 10px;font-weight:700}
    .list{display:grid;gap:10px}
    .item{border:1px dashed var(--line);border-radius:12px;padding:10px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <section class="hero">
    <img src="https://i.ibb.co/k2wtWBrW/unnamed.jpg" alt="Ø´Ø¹Ø§Ø± Ù„Ù…Ø¹Ø©" style="max-width:160px;display:block;margin:0 auto 8px;border-radius:14px;box-shadow:0 4px 14px rgba(0,0,0,.06);">
    <h1>Ø§Ø­Ø¬Ø² ØºØ³ÙŠÙ„ Ø³ÙŠØ§Ø±ØªÙƒ Ø§Ù„Ø¢Ù†</h1>
    <p>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØºØ³ÙŠÙ„ØŒ Ø­Ø¯Ù‘Ø¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©ØŒ ÙˆØ«Ø¨Ù‘Øª Ø§Ù„Ø­Ø¬Ø² ÙÙˆØ±Ù‹Ø§.</p>
  </section>

  <div id="statusBanner" class="formWrap" style="display:none;">
    <p id="statusText" style="margin:0;font-weight:800;"></p>
  </div>

  <section class="container">
    <form class="formWrap" id="bookingForm">
      <!-- (1) Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ -->
      <fieldset><legend>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</legend>
        <input id="phone" name="phone" type="tel" required placeholder="9xxxxxxxx" inputmode="tel" autocomplete="tel">
      </fieldset>

      <!-- (2) Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
      <fieldset><legend>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</legend>
        <select id="carType" name="carType" required>
          <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</option>
          <option value="ØµØ§Ù„ÙˆÙ†">ØµØ§Ù„ÙˆÙ†</option>
          <option value="ÙÙˆØ±ÙˆÙŠÙ„">ÙÙˆØ±ÙˆÙŠÙ„</option>
        </select>
      </fieldset>

      <!-- (2.1 & 2.2) Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„ÙˆØ­Ø©: Ø±Ù‚Ù… + Ø±Ù…Ø² (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ) -->
      <fieldset><legend>Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</legend>
        <div class="row-2">
          <div>
            <label for="carNumber" class="subhint">Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©</label>
            <input id="carNumber" name="carNumber" type="text" required placeholder="e.g., 1234" pattern="\d{1,6}" inputmode="numeric">
          </div>
          <div>
            <label for="carCode" class="subhint">Ø±Ù…Ø²/Ø­Ø±Ù Ø§Ù„Ù„ÙˆØ­Ø© (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label>
            <input id="carCode" name="carCode" type="text" required placeholder="e.g., A" pattern="[A-Za-z]{1,2}" title="Ø£Ø¯Ø®Ù„ Ø­Ø±ÙÙ‹Ø§ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø£Ùˆ Ø­Ø±ÙÙŠÙ†">
          </div>
        </div>
      </fieldset>

      <!-- (3) Ù†ÙˆØ¹ Ø§Ù„ØºØ³ÙŠÙ„ -->
      <fieldset><legend>Ù†ÙˆØ¹ Ø§Ù„ØºØ³ÙŠÙ„</legend>
        <select id="package" name="package" required>
          <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØºØ³ÙŠÙ„</option>
          <option value="external">ØºØ³ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ</option>
          <option value="both">ØºØ³ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ ÙˆØ¯Ø§Ø®Ù„ÙŠ</option>
        </select>
      </fieldset>

      <!-- (4) Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
      <fieldset><legend>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</legend>
        <input id="address" type="text" placeholder="Ø§Ù†Ù‚Ø± Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©" readonly required>
        <input type="hidden" id="lat" name="lat"><input type="hidden" id="lng" name="lng">
      </fieldset>

      <div id="priceSection" class="inline-actions">
        <p class="price">Ø§Ù„Ø³Ø¹Ø±: <span id="priceValue">0.00</span> Ø±.Ø¹</p>
        <button class="btn success" type="button" id="confirmBtn" disabled>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²</button>
      </div>
      <p class="muted" id="queueHint" style="display:none;margin:6px 2px 0;"></p>
    </form>
  </section>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù (ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ù…Ø¹ ?staff=1) -->
  <section class="formWrap" id="staffPanel" style="display:none;">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px">
      <h2 style="margin:0">Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù</h2>
      <span class="badge" id="activeCount">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø´Ø·Ø©: 0</span>
    </div>
    <div class="list" id="activeList"></div>
  </section>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
  <div class="map-backdrop" id="mapModal" aria-hidden="true">
    <div class="map-card">
      <div id="map" role="application" aria-label="Ø®Ø±ÙŠØ·Ø© Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©"></div>
      <div class="map-actions">
        <button class="btn" type="button" id="useMyLocationBtn">ğŸ“ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
        <button class="btn success" type="button" id="confirmLocationBtn">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
        <button class="btn" type="button" id="closeMapBtn">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button>
        <span class="hint" id="pickedCoords"></span>
      </div>
    </div>
  </div>

  <!-- Ù‚Ø³Ù… Ø§Ù„Ø¯ÙØ¹ -->
  <div class="formWrap" id="paymentSection" style="display:none;">
    <h2 style="margin-top:0">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¯ÙØ¹</h2>
    <p style="color:var(--muted)">Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¹Ù„Ù‰ Ø±Ù‚Ù… 99808079.</p>
    <div class="inline-actions"><button class="btn primary" id="paymentButton" type="button">ØªÙ… Ø§Ù„Ø¯ÙØ¹</button></div>
  </div>

  <footer>Â© Ù„Ù…Ø¹Ø© â€” Ø®Ø¯Ù…Ø© ØºØ³ÙŠÙ„ Ø³ÙŠØ§Ø±Ø§Øª Ù…ØªÙ†Ù‚Ù„Ø©</footer>

  <!-- Ù…ÙƒØªØ¨Ø§Øª -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <script>
    /* ====== Firebase ====== */
    const firebaseConfig = {
      apiKey: "AIzaSyC_kRUAmKIFQwWK0Xrr8PeebnQbWGauu34",
      authDomain: "wash-a7ef9.firebaseapp.com",
      projectId: "wash-a7ef9",
      storageBucket: "wash-a7ef9.firebasestorage.app",
      messagingSenderId: "244309029995",
      appId: "1:244309029995:web:b5cb0534edce26aac3ed2e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* ====== Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© ====== */
    let map, marker, lastLatLng = null;
    let currentBookingId = null;
    let unsubscribeBooking = null;
    const ACTIVE_STATUSES = ['pending','confirmed','accepted']; // ØªØ¯Ø®Ù„ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
    const DONE_STATUSES = ['completed','rejected','declined','canceled']; // ØªÙØ³ØªØ¨Ø¹Ø¯ Ù…Ù† Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±

    $(function () {
      $('#address').on('click', openMapModal);
      $('#useMyLocationBtn').on('click', useMyCurrentLocation);
      $('#confirmLocationBtn').on('click', confirmPickedLocation);
      $('#closeMapBtn').on('click', closeMapModal);

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„ØºØ³ÙŠÙ„ Ø£Ùˆ Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©
      $('#package').on('change', updatePrice);
      $('#carType').on('change', updatePrice);
      updatePrice();

      document.getElementById('confirmBtn').addEventListener('click', onConfirmBooking);
      document.getElementById('paymentButton').addEventListener('click', onCompletePayment);

      ['phone','package','carType','carNumber','carCode'].forEach(id => {
        document.getElementById(id).addEventListener('input', toggleConfirmEnabled);
        document.getElementById(id).addEventListener('change', toggleConfirmEnabled);
      });

      // Ø¥Ø¬Ø¨Ø§Ø± Ø±Ù…Ø² Ø§Ù„Ù„ÙˆØ­Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙˆØ¨Ø£Ø­Ø±Ù ÙƒØ¨ÙŠØ±Ø© ÙÙ‚Ø·
      const codeInput = document.getElementById('carCode');
      codeInput.addEventListener('input', (e) => {
        e.target.value = e.target.value.toUpperCase().replace(/[^A-Z]/g,'');
      });

      // ØªÙØ¹ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù Ø¹Ù†Ø¯ ?staff=1
      const params = new URLSearchParams(location.search);
      if (params.get('staff') === '1') {
        document.getElementById('staffPanel').style.display = 'block';
        subscribeActiveList();
      }
    });

    // âœ… ØªØ³Ø¹ÙŠØ± Ø¨Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© + Ù†ÙˆØ¹ Ø§Ù„ØºØ³ÙŠÙ„
    function calcPrice(pkg, car) {
  const bump = 0.30; // global increase per price
  if (!pkg || !car) return 0;
  if (car === 'ØµØ§Ù„ÙˆÙ†') {
    if (pkg === 'external') return 1.00 + bump; // was 1.00
    if (pkg === 'both')     return 1.50 + bump; // was 1.50
  }
  if (car === 'ÙÙˆØ±ÙˆÙŠÙ„') {
    if (pkg === 'external') return 1.50 + bump; // was 1.50
    if (pkg === 'both')     return 2.00 + bump; // was 2.00
  }
  return 0;
}
function updatePrice() {
      const pkg  = document.getElementById('package').value;
      const car  = document.getElementById('carType').value;
      const price = calcPrice(pkg, car);
      document.getElementById('priceValue').innerText = price.toFixed(2);
      toggleConfirmEnabled();
    }

    function toggleConfirmEnabled() {
      const phone = document.getElementById('phone').value.trim();
      const pkg   = document.getElementById('package').value;
      const car   = document.getElementById('carType').value;
      const carNumber = (document.getElementById('carNumber')?.value || '').trim();
      const carCode   = (document.getElementById('carCode')?.value || '').trim();
      const price = calcPrice(pkg, car);
      const hasLocation = !!document.getElementById('lat').value && !!document.getElementById('lng').value;
      document.getElementById('confirmBtn').disabled = !(price > 0 && phone && car && carNumber && carCode && hasLocation);
    }

    /* ====== Ø§Ù„Ø®Ø±ÙŠØ·Ø© ====== */
    function openMapModal() {
      const modal = document.getElementById('mapModal');
      modal.style.display = 'flex';
      setTimeout(() => {
        if (!map) {
          map = L.map('map');
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);
          map.setView([23.5880, 58.3829], 12);
          tryLocateAndDraw();
          map.on('click', e => setMarker(e.latlng));
        }
        setTimeout(() => map.invalidateSize(), 60);
      }, 0);
    }

    function tryLocateAndDraw() {
      if (!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(pos => {
        const userLatLng = [pos.coords.latitude, pos.coords.longitude];
        map.setView(userLatLng, 15);
        const blueIcon = L.divIcon({
          html: '<div style="width:20px;height:20px;background:#4285F4;border:3px solid white;border-radius:50%;box-shadow:0 0 6px rgba(66,133,244,0.8);"></div>',
          className: ""
        });
        L.marker(userLatLng, { icon: blueIcon }).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ").openPopup();
        L.circle(userLatLng, { radius: 120, color: '#4285F4', fillColor: '#4285F4', fillOpacity: 0.2 }).addTo(map);
      }, () => {});
    }

    function setMarker(latlng) {
      lastLatLng = latlng;
      if (!marker) {
        marker = L.marker(latlng, { draggable: true }).addTo(map);
        marker.on('dragend', () => { lastLatLng = marker.getLatLng(); updatePickedCoordsText(); });
      } else {
        marker.setLatLng(latlng);
      }
      updatePickedCoordsText();
    }

    function updatePickedCoordsText() {
      if (!lastLatLng) return;
      document.getElementById('pickedCoords').textContent =
        `Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯: ${lastLatLng.lat.toFixed(6)}, ${lastLatLng.lng.toFixed(6)}`;
    }

    function confirmPickedLocation() {
      if (!lastLatLng) { alert('Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©.'); return; }
      document.getElementById('lat').value = lastLatLng.lat.toFixed(6);
      document.getElementById('lng').value = lastLatLng.lng.toFixed(6);
      document.getElementById('address').value = `${lastLatLng.lat.toFixed(6)}, ${lastLatLng.lng.toFixed(6)}`;
      toggleConfirmEnabled();
      closeMapModal();
    }

    function closeMapModal() { document.getElementById('mapModal').style.display = 'none'; }

    // ÙŠØ­Ø¯Ø¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆÙŠØºÙ„Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
    function useMyCurrentLocation() {
      if (!navigator.geolocation) {
        alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          const ll = { lat: pos.coords.latitude, lng: pos.coords.longitude };

          if (map) {
            map.setView([ll.lat, ll.lng], 16);
            setMarker(ll);
          }

          document.getElementById('lat').value = ll.lat.toFixed(6);
          document.getElementById('lng').value = ll.lng.toFixed(6);
          document.getElementById('address').value = `${ll.lat.toFixed(6)}, ${ll.lng.toFixed(6)}`;
          updatePickedCoordsText();
          toggleConfirmEnabled();

          closeMapModal();
        },
        err => {
          console.error('Ø®Ø·Ø£ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹:', err);
          alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ GPS ÙˆÙ…Ù†Ø­ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ù…ØªØµÙØ­.');
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }

    /* ====== Ø¨Ø§Ù†Ø± Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ====== */
    function showBanner(msg) {
      const b = document.getElementById('statusBanner');
      const t = document.getElementById('statusText');
      t.textContent = msg;
      b.style.display = 'block';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function subscribeToBooking(id) {
      if (unsubscribeBooking) unsubscribeBooking();
      unsubscribeBooking = db.collection('bookings').doc(id).onSnapshot(async snap => {
        const data = snap.data();
        if (!data) return;
        // ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ± Ø¹Ù†Ø¯ Ø£ÙŠ ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ø­Ø¬Ø²
        await updateQueuePositionBanner(id);

        if (data.status === 'accepted') {
          showBanner('ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ ÙˆØ³ÙŠÙ‚ÙˆÙ… Ø§Ù„ÙØ±ÙŠÙ‚ Ø¨Ø§Ù„ØªÙˆØ¬Ù‡ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³ÙŠØ§Ø±Ø©');
        }
        if (data.status === 'completed') {
          showBanner('ØªÙ… Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø®Ø¯Ù…Ø©ØŒ Ø´ÙƒØ±Ù‹Ø§ Ù„Ø§Ø®ØªÙŠØ§Ø±Ùƒ Ù„Ù†Ø§.');
        }
        if (data.status === 'rejected') {
          showBanner('Ù†Ø¹ØªØ°Ø±ØŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø¹Ø¯Ù… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¯ÙØ¹.');
        }
      });
    }

    async function updateQueuePositionBanner(bookingId) {
      try {
        const snap = await db.collection('bookings')
          .orderBy('createdAtMs')
          .get();
        const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        const actives = docs.filter(b => ACTIVE_STATUSES.includes(b.status));
        const index = actives.findIndex(d => d.id === bookingId);
        if (index >= 0) {
          const position = index + 1;
          const msg = `Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: ${position} Ù…Ù† ${actives.length}`;
          document.getElementById('queueHint').style.display = 'block';
          document.getElementById('queueHint').textContent = msg;
        } else {
          document.getElementById('queueHint').style.display = 'none';
        }
      } catch (e) {
        console.warn('queue calc error', e);
      }
    }

    /* ====== Ø§Ù„Ø­Ø¬Ø² ÙˆØ§Ù„Ø¯ÙØ¹ ====== */
    async function onConfirmBooking() {
      const form = document.getElementById('bookingForm');
      if (!form.checkValidity()) { form.reportValidity(); return; }
      if (!document.getElementById('lat').value || !document.getElementById('lng').value) { alert('ÙØ¶Ù„Ø§Ù‹ Ø­Ø¯Ù‘Ø¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©.'); return; }
      if (!document.getElementById('package').value) { alert('ÙØ¶Ù„Ø§Ù‹ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØºØ³ÙŠÙ„.'); return; }
      if (!document.getElementById('carType').value) { alert('ÙØ¶Ù„Ø§Ù‹ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©.'); return; }

      const now = Date.now();
      const booking = {
        phone: document.getElementById('phone').value.trim(),
        package: document.getElementById('package').value,
        carType: document.getElementById('carType').value,
        carNumber: document.getElementById('carNumber').value.trim(),
        carCode: document.getElementById('carCode').value.trim().toUpperCase(),
        address: document.getElementById('address').value.trim(),
        lat: document.getElementById('lat').value || null,
        lng: document.getElementById('lng').value || null,
        price: parseFloat(document.getElementById('priceValue').innerText) || 0,
        status: 'pending',
        createdAt: new Date(now).toISOString(),
        createdAtMs: now
      };

      try {
        // Ø­ÙØ¸ Ø§Ù„Ø­Ø¬Ø² Ø£ÙˆÙ„Ø§Ù‹
        const docRef = await db.collection('bookings').add(booking);
        currentBookingId = docRef.id;

        // Ø­Ø³Ø§Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø´Ø·Ø© (ÙŠØ´Ù…Ù„ Ø·Ù„Ø¨Ùƒ) Ø¨Ø¯ÙˆÙ† ÙÙ„ØªØ±Ø© ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…
        const snap = await db.collection('bookings')
          .orderBy('createdAtMs')
          .get();
        const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        const actives = docs.filter(b => ACTIVE_STATUSES.includes(b.status));
        const index = actives.findIndex(d => d.id === currentBookingId);
        const position = (index >= 0) ? index + 1 : actives.length;

        const msg = `ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ âœ…. Ø±Ù‚Ù…Ùƒ ÙÙŠ Ø§Ù„ØªØ³Ù„Ø³Ù„: ${position}`;
        alert(msg);
        showBanner(msg);
        document.getElementById('queueHint').style.display = 'block';
        document.getElementById('queueHint').textContent = `Ø±Ù‚Ù…Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: ${position} Ù…Ù† ${actives.length}`;

        // Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¬Ø² ÙˆØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        subscribeToBooking(currentBookingId);

        // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ø¯ÙØ¹
        document.getElementById('paymentSection').style.display = 'block';
        document.getElementById('paymentSection').scrollIntoView({ behavior: 'smooth' });
      } catch (err) {
        console.error('Save error:', err);
        alert('Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø­Ø¬Ø².\n' + (err && err.message ? err.message : ''));
      }
    }

    async function onCompletePayment() {
      try {
        if (!currentBookingId) { alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¬Ø² Ù‚ÙŠØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯.'); return; }

        await db.collection('bookings').doc(currentBookingId).update({
          status: 'confirmed',
          paidAt: new Date().toISOString()
        });

        const btn = document.getElementById('paymentButton');
        btn.textContent = 'ØªÙ… Ø§Ù„Ø¯ÙØ¹ âœ…';
        btn.classList.remove('primary');
        btn.classList.add('success');
        btn.disabled = true;

        alert('ØªÙ… Ø§Ù„Ø¯ÙØ¹ ÙˆØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­ âœ…');
        document.getElementById('paymentSection').style.display = 'block';

        // ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ø¯ÙˆØ± Ø¨Ø¹Ø¯ ØªØºÙŠÙ‘Ø± Ø§Ù„Ø­Ø§Ù„Ø©
        await updateQueuePositionBanner(currentBookingId);
      } catch (err) {
        console.error('Confirm error:', err);
        alert('Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹.\n' + (err && err.message ? err.message : ''));
      }
    }

    /* ====== Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù ====== */
    let unsubscribeActiveList = null;
    function subscribeActiveList() {
      if (unsubscribeActiveList) unsubscribeActiveList();
      // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØªØ±Ø´ÙŠØ­ Ø§Ù„Ù†Ø´Ø·Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
      unsubscribeActiveList = db.collection('bookings')
        .orderBy('createdAtMs')
        .onSnapshot(snap => {
          const docs = [];
          snap.forEach(doc => docs.push({id: doc.id, ...doc.data()}));
          const actives = docs.filter(b => ACTIVE_STATUSES.includes(b.status));
          document.getElementById('activeCount').textContent = `Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø´Ø·Ø©: ${actives.length}`;

          const list = document.getElementById('activeList');
          list.innerHTML = '';
          actives.forEach((b, i) => {
            const el = document.createElement('div');
            el.className = 'item';
            el.innerHTML = `
              <div style="min-width:0">
                <div style="font-weight:800">#${i+1} â€” ${b.carCode || ''} ${b.carNumber || ''} â€¢ ${b.carType || ''}</div>
                <div class="muted" style="font-size:.95rem">${b.package === 'both' ? 'Ø®Ø§Ø±Ø¬ÙŠ ÙˆØ¯Ø§Ø®Ù„ÙŠ' : 'Ø®Ø§Ø±Ø¬ÙŠ ÙÙ‚Ø·'} â€¢ ${b.phone} â€¢ ${new Date(b.createdAt).toLocaleString('ar')}</div>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn light" onclick="staffAccept('${b.id}')">Ø¨Ø¯Ø¡ / Ù‚Ø¨ÙˆÙ„</button>
                <button class="btn success" onclick="staffComplete('${b.id}')">ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°</button>
                <button class="btn" onclick="staffReject('${b.id}')">Ø±ÙØ¶ Ø§Ù„Ù…Ù‡Ù…Ø©</button>
              </div>
            `;
            list.appendChild(el);
          });
        }, err => {
          console.error('active list error', err);
        });
    }

    async function staffAccept(id) {
      try {
        await db.collection('bookings').doc(id).update({ status: 'accepted', acceptedAt: new Date().toISOString() });
      } catch (e) { console.error(e); alert('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©.\n' + (e && e.message ? e.message : '')); }
    }
    async function staffComplete(id) {
      try {
        await db.collection('bookings').doc(id).update({ status: 'completed', completedAt: new Date().toISOString() });
      } catch (e) { console.error(e); alert('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©.\n' + (e && e.message ? e.message : '')); }
    }
    async function staffReject(id) {
      try {
        await db.collection('bookings').doc(id).update({ status: 'rejected', rejectedAt: new Date().toISOString() });
      } catch (e) { console.error(e); alert('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©.\n' + (e && e.message ? e.message : '')); }
    }
  </script>
</body>
</html>
